<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SlumLink | Complaints</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --sand:#CBB093;
  --sand2:#E0C7AC;
  --paper:#FFF4E6;
  --terra:#A4624D;
  --ink:#613729;
  --warning:#E8A444;
  --header-h:56px;
}

*{box-sizing:border-box;margin:0;padding:0;}

body{
  font-family:"Poppins", sans-serif;
  background: linear-gradient(116.82deg,#CBB093 21.58%,#E0C7AC 31.36%,#F8E5CF 50.73%,#C0E0D0 71.52%);
  color: var(--ink);
  min-height:100vh;
}

/* ================= HEADER ================= */

.topbar{
  position:fixed; top:0; left:0; right:0;
  height:56px; background:var(--paper);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 70px; z-index:50;
}

.brand{
  display:flex;align-items:center;gap:10px;cursor:pointer;
}

.brand-mark{
  width:32px;height:32px;border-radius:14px;
  background:linear-gradient(143deg, rgba(164,98,77,.75), rgba(223,164,119,.75));
}

.brand-text{
  font-size:20px;font-weight:500;
  color:rgba(164,98,77,.86);
}

.pill-btn{
  height:34px;padding:0 14px;border-radius:14px;
  font-weight:700;font-size:14px;
  border:1px solid rgba(97,55,41,.14);
  background:rgba(255,244,230,.85);
  color:rgba(97,55,41,.78);
  display:flex;align-items:center;gap:8px;
  cursor:pointer;
}

/* ================= MAIN ================= */

.container{
  max-width:1200px;
  margin:100px auto 60px;
  padding:0 40px;
}

.category-title{
  font-size:36px;
  font-weight:700;
  margin-bottom:25px;
}

/* ================= FILTER BUTTONS ================= */

.filters{
  margin-bottom:30px;
}

.filter-btn{
  padding:8px 18px;
  margin-right:10px;
  border-radius:18px;
  border:1px solid var(--sand);
  background:var(--paper);
  color:var(--ink);
  cursor:pointer;
  font-weight:500;
}

.filter-btn.active{
  background:var(--terra);
  color:white;
}

/* ================= COMPLAINT CARDS ================= */

.complaints-container{
  display:flex;
  flex-direction:column;
  gap:20px;
}

.complaint-card{
  background:var(--paper);
  border:1px solid var(--sand);
  border-radius:18px;
  box-shadow:5px 5px 4px rgba(173,117,98,0.24);
  padding:20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  transition:0.2s ease;
}

.complaint-card:hover{
  transform:translateY(-3px);
}

.complaint-text{
  font-size:18px;
  font-weight:500;
}

.status-box{
  padding:6px 14px;
  border-radius:20px;
  font-size:14px;
  font-weight:600;
}

.Pending{
  background:var(--warning);
  color:white;
}

.InProgress{
  background:#6BAED6;
  color:white;
}

.Solved{
  background:#7BB662;
  color:white;
}

/* ================= FOOTER ================= */

.footer{
  text-align:center;
  padding:20px;
  font-size:14px;
  color:rgba(97,55,41,.7);
}
</style>
</head>

<body>

<header class="topbar">
  <div class="brand" id="brandBtn">
    <img src="/src/images/slum Logo.png" class="brand-mark"/>
    <div class="brand-text">SLUMLINK</div>
  </div>

  <button class="pill-btn" id="backBtn">
    <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
  </button>
</header>

<main class="container">

  <h1 class="category-title" id="categoryTitle">Complaints</h1>

  <div class="filters">
    <button class="filter-btn active" data-status="All">All</button>
    <button class="filter-btn" data-status="Pending">Pending</button>
    <button class="filter-btn" data-status="InProgress">In Progress</button>
    <button class="filter-btn" data-status="Solved">Solved</button>
  </div>

  <div class="complaints-container" id="complaintsContainer"></div>

</main>

<footer class="footer">
  Â© 2026 SlumLink | Local Authority Portal
</footer>

<script>
const brandBtn = document.getElementById("brandBtn");
const backBtn = document.getElementById("backBtn");

if (brandBtn) {
  brandBtn.onclick = () => location.href = "/";
}

if (backBtn) {
  backBtn.onclick = () => location.href = "./local-dashboard.html";
}


const urlParams = new URLSearchParams(window.location.search);
const category = urlParams.get("category") || "Complaints";
document.getElementById("categoryTitle").textContent = category;

let allComplaints = [];
const container = document.getElementById("complaintsContainer");

function normalizeStatus(dbStatus){
  if(dbStatus === "resolved") return "Solved";
  if(dbStatus === "in progress") return "InProgress";
  return "Pending";
}

async function fetchComplaints(){
  try{
    // Get division from localStorage session
    const sessionRaw = localStorage.getItem("SLUMLINK_SESSION");
    const session = sessionRaw ? JSON.parse(sessionRaw) : {};
    const division = session.division || "";
    
    // Build URL with category and optional division parameter
    let url = `/api/complaints?category=${encodeURIComponent(category)}`;
    if (division) {
      url += `&division=${encodeURIComponent(division)}`;
    }
    
    const res = await fetch(url);
    const data = await res.json();

    allComplaints = (data || []).map(c => ({
      id: c.complaint_id,
      text: c.title,
      description: c.description,
      status: normalizeStatus(c.status)
    }));

    renderComplaints("All");
  }catch(err){
    console.error(err);
  }
}

function renderComplaints(filter="All"){
  container.innerHTML = "";

  const filtered = allComplaints.filter(c =>
    filter==="All" || c.status===filter
  );

  if(filtered.length===0){
    container.innerHTML = "<p>No complaints found.</p>";
    return;
  }

  filtered.forEach(c=>{
    const card = document.createElement("div");
    card.className="complaint-card";
    card.innerHTML=`
      <div class="complaint-text">${c.text}</div>
      <div class="status-box ${c.status}">${c.status}</div>
    `;
  card.onclick = ()=>{
  window.location.href = `./complaintprofile.html?id=${c.id}`;
};

    container.appendChild(card);
  });
}

document.querySelectorAll(".filter-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    renderComplaints(btn.dataset.status);
  });
});

fetchComplaints();
</script>

</body>
</html>
