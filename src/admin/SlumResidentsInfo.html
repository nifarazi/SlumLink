<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SLUMLINK ¬∑ Resident Information</title>
  <link rel="stylesheet" href="adminSlumAnalytics.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    .info-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .info-section h3 {
      margin-top: 0;
      color: #7D5A3B;
      border-bottom: 2px solid #7D5A3B;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
    .info-item {
      display: flex;
      flex-direction: column;
    }
    .info-label {
      font-weight: 600;
      color: #555;
      font-size: 0.9em;
      margin-bottom: 5px;
    }
    .info-value {
      color: #333;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    .profile-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #7D5A3B 0%, #9B8066 100%);
      border-radius: 8px;
      color: white;
    }
    .profile-header-info h2 {
      margin: 0 0 5px 0;
    }
    .profile-header-info p {
      margin: 0;
      opacity: 0.9;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .subsection {
      margin-top: 15px;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #7D5A3B;
      border-radius: 4px;
    }
    .subsection h4 {
      margin-top: 0;
      color: #7D5A3B;
    }
    .loading {
      text-align: center;
      color: #999;
      padding: 40px;
      font-size: 16px;
    }
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .document-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .document-modal-overlay.active {
      display: flex;
    }
    .document-modal {
      background: white;
      border-radius: 8px;
      max-width: 600px;
      max-height: 80vh;
      overflow: auto;
      padding: 0;
      position: relative;
    }
    .document-modal-header {
      padding: 16px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: #f5f5f5;
    }
    .document-modal-header h3 {
      margin: 0;
      color: #7D5A3B;
    }
    .document-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    .document-modal-body {
      padding: 20px;
      text-align: center;
    }
    .document-modal-body img {
      max-width: 100%;
      max-height: 500px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header class="topbar" aria-label="Header">
    <div class="brand clickable" id="brandBtn" aria-label="SlumLink Home" role="button" tabindex="0">
      <img src="/src/images/slum Logo.png" alt="SlumLink Logo" class="logo-mark" />
      <div class="brand-text">SLUMLINK</div>
    </div>

    <input type="text" placeholder="Search" class="search" />

    <div class="top-right">
      <div class="admin">
        <span>Admin ‚ñæ</span>
        <div class="admin-dropdown">
          <button class="admin-logout" id="logoutBtn" type="button" aria-label="Log out">Logout</button>
        </div>
      </div>
      <div class="notification-bell-container">
        <a class="bell" href="adminNotification.html" title="Notifications">üîî</a>
        <span class="notification-badge" id="notificationBadge">0</span>
      </div>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <ul>
        <li><a href="adminSlumAnalytics.html">üìä Slum Analytics</a></li>
        <li><a href="adminNgoAnalytics.html">üìà NGO Analytics</a></li>
        <li class="active"><a href="adminslumdivision.html">üè† Slum Residents</a></li>
        <li><a href="adminFieldAgents.html">üßë‚Äçüíº Field Agents</a></li>
        <li><a href="adminactivengo.html">‚úÖ Active NGOs</a></li>
        <li><a href="adminlocalauthority.html">üèõ Local Authority</a></li>
        <li><a href="adminVerifyNgo.html">‚úî Verify NGOs</a></li>
        <li><a href="adminviewcomplaints.html">üìã View Complaints</a></li>
      </ul>
    </aside>

    <main class="content" id="mainContent">
      <div class="loading">Loading resident information...</div>
    </main>
  </div>

  <!-- Logout Modal -->
  <div class="modal-overlay" id="logoutModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="logoutTitle">
      <div class="modal-header" id="logoutTitle">Log out</div>
      <div class="modal-body">You're currently signed in as Admin. Do you want to log out and return to the home page?</div>
      <div class="modal-actions">
        <button id="cancelLogout" type="button">Cancel</button>
        <button id="confirmLogout" type="button" style="background-color: #8b6f5a; color: white;">Log out</button>
      </div>
    </div>
  </div>

  <!-- Document View Modal -->
  <div class="document-modal-overlay" id="documentModal">
    <div class="document-modal">
      <div class="document-modal-header">
        <h3 id="documentTitle">Document</h3>
        <button class="document-modal-close" onclick="closeDocumentModal()">√ó</button>
      </div>
      <div class="document-modal-body" id="documentContent">
        Loading...
      </div>
    </div>
  </div>

  <script src="adminSlumAnalytics.js"></script>
  <script>
    let currentResident = null;
    let currentResidentId = null;

    function formatDate(value) {
      if (!value) return '-';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return value;
      return d.toISOString().split('T')[0];
    }

    function formatSkills(entity) {
      if (!entity) return '-';
      const skills = [entity.skills_1, entity.skills_2]
        .map((s) => (s || '').trim())
        .filter((s) => s);
      return skills.length ? skills.join(', ') : '-';
    }

    function renderMemberDocButtons(memberType, member, labels) {
      const buttons = [];
      if (memberType === 'spouse') {
        if (member.has_marriage_certificate) {
          buttons.push({ type: 'marriage_certificate', label: labels.marriage });
        }
        if (member.has_divorce_certificate) {
          buttons.push({ type: 'divorce_certificate', label: labels.divorce });
        }
      }

      if (memberType === 'child') {
        if (member.has_birth_certificate) {
          buttons.push({ type: 'birth_certificate', label: labels.birth });
        }
        if (member.has_death_certificate) {
          buttons.push({ type: 'death_certificate', label: labels.death });
        }
      }

      if (buttons.length === 0) return '';

      return `
        <div class="action-buttons">
          ${buttons
            .map((btn) => `
              <button class="btn btn-secondary" onclick="viewMemberDocument('${memberType}', ${member.id}, '${btn.type}')">${btn.label}</button>
            `)
            .join('')}
        </div>
      `;
    }

    function buildMemberDocumentsFromResident() {
      const resident = currentResident?.resident;
      if (!resident?.slum_code) return [];

      const allSpouses = currentResident?.spouses || [];
      const allChildren = currentResident?.children || [];

      const activeSpouses = allSpouses.filter((spouse) => spouse.status === 'active');
      const activeChildren = allChildren.filter((child) => child.status === 'active');

      const documents = [];

      activeSpouses.forEach((spouse) => {
        if (spouse.has_marriage_certificate) {
          documents.push({
            source: 'member',
            member_type: 'spouse',
            member_id: spouse.id,
            member_name: spouse.name,
            document_type: 'marriage_certificate',
            document_title: 'Marriage Certificate',
            uploaded_at: spouse.created_at
          });
        }
        if (spouse.has_divorce_certificate) {
          documents.push({
            source: 'member',
            member_type: 'spouse',
            member_id: spouse.id,
            member_name: spouse.name,
            document_type: 'divorce_certificate',
            document_title: 'Divorce Certificate',
            uploaded_at: spouse.created_at
          });
        }
      });

      activeChildren.forEach((child) => {
        if (child.has_birth_certificate) {
          documents.push({
            source: 'member',
            member_type: 'child',
            member_id: child.id,
            member_name: child.name,
            document_type: 'birth_certificate',
            document_title: 'Birth Certificate',
            uploaded_at: child.created_at
          });
        }
        if (child.has_death_certificate) {
          documents.push({
            source: 'member',
            member_type: 'child',
            member_id: child.id,
            member_name: child.name,
            document_type: 'death_certificate',
            document_title: 'Death Certificate',
            uploaded_at: child.created_at
          });
        }
      });

      return documents;
    }

    document.addEventListener('DOMContentLoaded', async function () {
      const mainContent = document.getElementById('mainContent');
      const params = new URLSearchParams(window.location.search);
      const residentId = params.get('id');

      if (!residentId) {
        mainContent.innerHTML = '<div class="error-message">No resident ID provided.</div>';
        return;
      }

      currentResidentId = residentId;
      await loadResident(mainContent);
    });

    async function loadResident(mainContent) {
      try {
        const response = await fetch(`/api/slum-dweller/${currentResidentId}`);
        const result = await response.json();

        if (result.status !== 'success' || !result.data) {
          mainContent.innerHTML = '<div class="error-message">Failed to load resident information. ' + (result.message || '') + '</div>';
          return;
        }

        currentResident = result.data;
        renderResidentInfo();
      } catch (error) {
        console.error('Error loading resident:', error);
        mainContent.innerHTML = '<div class="error-message">Error loading resident information. Please try again.</div>';
      }
    }

    function renderResidentInfo() {
      const mainContent = document.getElementById('mainContent');
      const resident = currentResident.resident;
      const allSpouses = currentResident.spouses || [];
      const allChildren = currentResident.children || [];
      const activeSpouses = allSpouses.filter((spouse) => spouse.status === 'active');
      const activeChildren = allChildren.filter((child) => child.status === 'active');
      const pendingSpouses = allSpouses.filter((spouse) => spouse.status === 'pending_add' || spouse.status === 'pending_remove');
      const pendingChildren = allChildren.filter((child) => child.status === 'pending_add' || child.status === 'pending_remove');

      const statusBadge = resident.status === 'accepted' ? '<span style="background: rgba(45, 122, 61, 0.15); color: #2d7a3d; padding: 4px 8px; border-radius: 4px; font-weight: bold;">Active</span>' : 
                         resident.status === 'pending' ? '<span style="background: rgba(217, 165, 116, 0.15); color: #d9a574; padding: 4px 8px; border-radius: 4px; font-weight: bold;">Pending</span>' : 
                         '<span style="background: rgba(180, 80, 80, 0.2); color: #a83e3e; padding: 4px 8px; border-radius: 4px; font-weight: bold;">Rejected</span>';

      let html = `
        <div class="profile-header">
          <div class="profile-header-info">
            <h2>${resident.full_name || 'Unknown'}</h2>
            <p><strong>ID:</strong> ${resident.id} | <strong>Slum Code:</strong> ${resident.slum_code || '-'}</p>
            <p style="margin-top: 8px;">${statusBadge}</p>
          </div>
        </div>

        <!-- Personal Information -->
        <div class="info-section">
          <h3>Personal Information</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Full Name</span>
              <span class="info-value">${resident.full_name || '-'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Date of Birth</span>
              <span class="info-value">${formatDate(resident.dob)}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Gender</span>
              <span class="info-value">${resident.gender || '-'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">NID Number</span>
              <span class="info-value">${resident.nid || '-'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Mobile Number</span>
              <span class="info-value">${resident.mobile || '-'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Education</span>
              <span class="info-value">${resident.education || '-'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Occupation</span>
              <span class="info-value">${resident.occupation || '-'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Skills</span>
              <span class="info-value">${formatSkills(resident)}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Income Range</span>
              <span class="info-value">${resident.income || '-'}</span>
            </div>
          </div>
        </div>

        <!-- Address Information -->
        <div class="info-section">
          <h3>Address Information</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Area</span>
              <span class="info-value">${resident.area || '-'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">District</span>
              <span class="info-value">${resident.district || '-'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Division</span>
              <span class="info-value">${resident.division || '-'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Family Members</span>
              <span class="info-value">${resident.family_members || 0}</span>
            </div>
          </div>
        </div>
      `;

      // Spouses
      if (activeSpouses.length > 0) {
        html += '<div class="info-section"><h3>Spouse Information (' + activeSpouses.length + ')</h3>';
        activeSpouses.forEach((spouse, idx) => {
          html += `
            <div class="subsection">
              <h4>Spouse ${idx + 1}</h4>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Name</span>
                  <span class="info-value">${spouse.name || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Date of Birth</span>
                  <span class="info-value">${formatDate(spouse.dob)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Gender</span>
                  <span class="info-value">${spouse.gender || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">NID</span>
                  <span class="info-value">${spouse.nid || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Education</span>
                  <span class="info-value">${spouse.education || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Job</span>
                  <span class="info-value">${spouse.job || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Skills</span>
                  <span class="info-value">${formatSkills(spouse)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Income Range</span>
                  <span class="info-value">${spouse.income || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Mobile</span>
                  <span class="info-value">${spouse.mobile || '-'}</span>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      // Children
      if (activeChildren.length > 0) {
        html += '<div class="info-section"><h3>Children Information (' + activeChildren.length + ')</h3>';
        activeChildren.forEach((child, idx) => {
          html += `
            <div class="subsection">
              <h4>Child ${idx + 1}</h4>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Name</span>
                  <span class="info-value">${child.name || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Birth Certificate No.</span>
                  <span class="info-value">${child.birth_certificate_number || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Date of Birth</span>
                  <span class="info-value">${formatDate(child.dob)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Gender</span>
                  <span class="info-value">${child.gender || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Education</span>
                  <span class="info-value">${child.education || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Job</span>
                  <span class="info-value">${child.job || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Skills</span>
                  <span class="info-value">${formatSkills(child)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Income Range</span>
                  <span class="info-value">${child.income || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Preferred Job</span>
                  <span class="info-value">${child.preferred_job || '-'}</span>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      // Pending updates section
      if (pendingSpouses.length > 0 || pendingChildren.length > 0) {
        html += '<div class="info-section"><h3>Pending Updates</h3>';

        pendingSpouses.forEach((spouse, idx) => {
          const updateLabel = spouse.status === 'pending_add' ? 'Add request' : 'Remove request';
          const docButtons = renderMemberDocButtons('spouse', spouse, {
            marriage: 'View Marriage Certificate',
            divorce: 'View Divorce Certificate'
          });
          html += `
            <div class="subsection">
              <h4>Spouse Update ${idx + 1} (${updateLabel})</h4>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Name</span>
                  <span class="info-value">${spouse.name || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">NID</span>
                  <span class="info-value">${spouse.nid || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Mobile</span>
                  <span class="info-value">${spouse.mobile || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Skills</span>
                  <span class="info-value">${formatSkills(spouse)}</span>
                </div>
              </div>
              ${docButtons}
              <div class="action-buttons">
                <button class="btn btn-primary" data-update-type="spouse" data-update-id="${spouse.id}" data-update-action="approve">Accept</button>
                <button class="btn btn-secondary" data-update-type="spouse" data-update-id="${spouse.id}" data-update-action="reject">Reject</button>
              </div>
            </div>
          `;
        });

        pendingChildren.forEach((child, idx) => {
          const updateLabel = child.status === 'pending_add' ? 'Add request' : 'Remove request';
          const docButtons = renderMemberDocButtons('child', child, {
            birth: 'View Birth Certificate',
            death: 'View Death Certificate'
          });
          html += `
            <div class="subsection">
              <h4>Child Update ${idx + 1} (${updateLabel})</h4>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Name</span>
                  <span class="info-value">${child.name || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Birth Certificate No.</span>
                  <span class="info-value">${child.birth_certificate_number || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Education</span>
                  <span class="info-value">${child.education || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Skills</span>
                  <span class="info-value">${formatSkills(child)}</span>
                </div>
              </div>
              ${docButtons}
              <div class="action-buttons">
                <button class="btn btn-primary" data-update-type="child" data-update-id="${child.id}" data-update-action="approve">Accept</button>
                <button class="btn btn-secondary" data-update-type="child" data-update-id="${child.id}" data-update-action="reject">Reject</button>
              </div>
            </div>
          `;
        });

        html += '</div>';
      }

      // Action buttons
      html += `
        <!-- Documents Section -->
        <div class="info-section">
          <h3>Submitted Documents</h3>
          <div id="documentsContainer">
            <p style="color: #999;">Loading documents...</p>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" id="generateReportBtn">üìÑ Generate Report</button>
          <button class="btn btn-secondary" onclick="history.back()">‚Üê Go Back</button>
        </div>
      `;

      mainContent.innerHTML = html;

      // Load documents
      loadDocuments(resident.slum_code);

      // Attach PDF generation handler
      document.getElementById('generateReportBtn').addEventListener('click', generatePdf);

      // Attach update review handlers
      document.querySelectorAll('[data-update-action]').forEach((button) => {
        button.addEventListener('click', handleUpdateReview);
      });
    }

    async function handleUpdateReview(event) {
      const button = event.currentTarget;
      const updateType = button.getAttribute('data-update-type');
      const updateId = button.getAttribute('data-update-id');
      const action = button.getAttribute('data-update-action');
      const resident = currentResident.resident;

      if (!updateType || !updateId || !action || !resident?.slum_code) return;

      const endpoint = `/api/slum-dweller/${resident.slum_code}/${updateType}/${updateId}/review`;

      try {
        button.disabled = true;
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action })
        });
        const result = await response.json();

        if (result.status !== 'success') {
          alert(result.message || 'Failed to update request.');
          button.disabled = false;
          return;
        }

        await loadResident(document.getElementById('mainContent'));
      } catch (error) {
        console.error('Error reviewing update:', error);
        alert('Error processing the update. Please try again.');
        button.disabled = false;
      }
    }

    async function viewMemberDocument(memberType, memberId, docType) {
      const resident = currentResident?.resident;
      if (!resident?.slum_code) return;

      const endpoint = `/api/slum-dweller/${resident.slum_code}/${memberType}/${memberId}/document/${docType}`;

      try {
        const response = await fetch(endpoint);
        if (!response.ok) {
          const message = await response.text();
          throw new Error(message || 'Failed to load document');
        }

        const contentType = response.headers.get('content-type') || 'application/octet-stream';
        const blob = await response.blob();
        const objectUrl = URL.createObjectURL(blob);

        const modalTitle = document.getElementById('documentTitle');
        const modalContent = document.getElementById('documentContent');
        const modal = document.getElementById('documentModal');

        const titleText = docType.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
        modalTitle.textContent = titleText;

        if (contentType.startsWith('image/')) {
          modalContent.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 16px; align-items: center; padding: 10px 0;">
              <img src="${objectUrl}" alt="${titleText}" style="max-height: 500px; max-width: 100%; border-radius: 4px;" />
              <a href="${objectUrl}" download="${docType}" style="display: inline-block; padding: 10px 20px; background: #7D5A3B; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">‚¨á Download</a>
            </div>
          `;
        } else if (contentType === 'application/pdf') {
          modalContent.innerHTML = `
            <div style="padding: 20px;">
              <iframe src="${objectUrl}" style="width: 100%; height: 480px; border: none;"></iframe>
              <div style="margin-top: 12px;">
                <a href="${objectUrl}" download="${docType}.pdf" style="display: inline-block; padding: 10px 20px; background: #7D5A3B; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">‚¨á Download PDF</a>
              </div>
            </div>
          `;
        } else {
          modalContent.innerHTML = `
            <div style="padding: 20px;">
              <p style="font-size: 48px; margin: 20px 0;">üìé</p>
              <p style="font-weight: bold;">Document Ready</p>
              <p style="color: #999; margin-bottom: 20px;">Preview is not available for this file type.</p>
              <a href="${objectUrl}" download="${docType}" style="display: inline-block; padding: 10px 20px; background: #7D5A3B; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">‚¨á Download File</a>
            </div>
          `;
        }

        modal.classList.add('active');
      } catch (error) {
        console.error('Error viewing member document:', error);
        alert('Failed to load document.');
      }
    }

    // Load and display documents
    async function loadDocuments(slumCode) {
      try {
        console.log('Loading documents for slumCode:', slumCode);
        const [residentResponse, memberResponse] = await Promise.all([
          fetch(`/api/documents/${slumCode}/all`),
          fetch(`/api/slum-dweller/${slumCode}/member-documents`)
        ]);

        console.log('Documents response status:', residentResponse.status);
        console.log('Member documents response status:', memberResponse.status);

        const container = document.getElementById('documentsContainer');

        let residentResult = { success: false, documents: [] };
        let memberResult = { status: 'error', data: [] };

        if (residentResponse.ok) {
          try {
            residentResult = await residentResponse.json();
          } catch (error) {
            console.error('Error parsing resident documents:', error);
          }
        } else {
          console.error('Resident documents request failed:', residentResponse.status);
        }

        if (memberResponse.ok) {
          try {
            memberResult = await memberResponse.json();
          } catch (error) {
            console.error('Error parsing member documents:', error);
          }
        } else {
          console.error('Member documents request failed:', memberResponse.status);
        }

        const residentDocs = residentResult.documents || [];
        const memberDocs = (memberResult.data || []).length
          ? memberResult.data
          : buildMemberDocumentsFromResident();
        const allDocs = residentDocs.concat(memberDocs);

        if (allDocs.length === 0) {
          console.log('No documents found for slumCode:', slumCode);
          container.innerHTML = '<p style="color: #999;">No documents submitted.</p>';
          return;
        }

        let html = '<div style="display: grid; gap: 12px;">';

        allDocs.forEach(doc => {
          const uploadDate = doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '-';
          let statusBadge = '';
          let statusColor = '';

          statusBadge = '';
          statusColor = '';

          const subtitle = doc.source === 'member'
            ? `Accepted member document ¬∑ ${doc.member_type === 'spouse' ? 'Spouse' : 'Child'}: ${doc.member_name || '-'}`
            : `Type: ${doc.document_type}`;

          const actionButton = doc.source === 'member'
            ? `<button onclick="viewMemberDocument('${doc.member_type}', ${doc.member_id}, '${doc.document_type}')" style="padding: 6px 12px; background: #7D5A3B; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">View Document</button>`
            : `<button onclick="viewDocument(${doc.id})" style="padding: 6px 12px; background: #7D5A3B; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">View Document</button>`;

          html += `
            <div style="padding: 12px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <div>
                  <div style="font-weight: bold; color: #7D5A3B; margin-bottom: 4px;">${doc.document_title || doc.document_type}</div>
                  <div style="font-size: 12px; color: #999;">${subtitle}</div>
                </div>
                ${statusBadge ? `<span style="background: rgba(${statusColor === '#2d7a3d' ? '45, 122, 61' : statusColor === '#a83e3e' ? '168, 62, 62' : statusColor === '#d9a574' ? '217, 165, 116' : '107, 91, 75'}, 0.15); color: ${statusColor}; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; white-space: nowrap;">${statusBadge}</span>` : ''}
              </div>
              <div style="font-size: 12px; color: #999; margin-bottom: 8px;">
                Uploaded: ${uploadDate}
                ${doc.file_size ? ` | Size: ${(doc.file_size / 1024).toFixed(2)} KB` : ''}
              </div>
              ${doc.status === 'rejected' && doc.rejection_reason ? `<div style="font-size: 12px; color: #a83e3e; background: rgba(168, 62, 62, 0.1); padding: 8px; border-radius: 4px; margin-bottom: 8px;">Reason: ${doc.rejection_reason}</div>` : ''}
              ${actionButton}
            </div>
          `;
        });

        html += '</div>';
        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading documents:', error);
        document.getElementById('documentsContainer').innerHTML = '<p style="color: red;">Failed to load documents.</p>';
      }
    }

    // View document function
    async function viewDocument(docId) {
      try {
        console.log('Fetching document:', docId);
        const response = await fetch(`/api/documents/view/${docId}`);
        const result = await response.json();
        console.log('Document response:', result);
        
        if (result.status !== 'success' || !result.data) {
          console.error('Document fetch failed:', result);
          alert('Failed to load document');
          return;
        }

        const doc = result.data;
        const modalTitle = document.getElementById('documentTitle');
        const modalContent = document.getElementById('documentContent');
        const modal = document.getElementById('documentModal');
        
        modalTitle.textContent = doc.document_title || doc.document_type;
        
        if (doc.file_mimetype.startsWith('image/')) {
          modalContent.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 16px; align-items: center; padding: 10px 0;">
              <img src="${doc.file_data}" alt="Document image" style="max-height: 500px; max-width: 100%; border-radius: 4px;" />
              <a href="${doc.file_data}" download="${(doc.document_title || doc.document_type || 'document')}.png" style="display: inline-block; padding: 10px 20px; background: #7D5A3B; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">‚¨á Download Image</a>
            </div>
          `;
        } else if (doc.file_mimetype === 'application/pdf') {
          modalContent.innerHTML = `
            <div style="padding: 20px;">
              <p style="font-size: 48px; margin: 20px 0;">üìÑ</p>
              <p style="font-weight: bold;">PDF Document</p>
              <p style="color: #999; margin-bottom: 20px;">Click the button below to download this PDF</p>
              <a href="${doc.file_data}" download="${doc.document_title || 'document'}.pdf" style="display: inline-block; padding: 10px 20px; background: #7D5A3B; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">‚¨á Download PDF</a>
            </div>
          `;
        } else {
          modalContent.innerHTML = `
            <div style="padding: 20px;">
              <p style="font-size: 48px; margin: 20px 0;">üìé</p>
              <p style="font-weight: bold;">${doc.file_mimetype}</p>
              <p style="color: #999; margin-bottom: 20px;">This file type cannot be previewed in browser</p>
              <a href="${doc.file_data}" download="${doc.document_title || 'document'}" style="display: inline-block; padding: 10px 20px; background: #7D5A3B; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">‚¨á Download File</a>
            </div>
          `;
        }
        
        modal.classList.add('active');
      } catch (error) {
        console.error('Error viewing document:', error);
        alert('Failed to view document: ' + error.message);
      }
    }

    function closeDocumentModal() {
      const modal = document.getElementById('documentModal');
      modal.classList.remove('active');
    }

    // Close modal when clicking outside
    document.getElementById('documentModal')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closeDocumentModal();
      }
    });

    function generatePdf() {
      const jsPDFCtor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
      if (!jsPDFCtor) {
        alert('PDF library not loaded');
        return;
      }

      const doc = new jsPDFCtor({ unit: 'pt', format: 'a4' });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 30;
      let yPosition = margin;

      function addLine(text, fontSize = 12, isBold = false) {
        if (yPosition > pageHeight - 40) {
          doc.addPage();
          yPosition = margin;
        }
        doc.setFontSize(fontSize);
        doc.setFont('helvetica', isBold ? 'bold' : 'normal');
        const lines = doc.splitTextToSize(text || '', pageWidth - 2 * margin);
        lines.forEach(line => {
          doc.text(line, margin, yPosition);
          yPosition += fontSize + 5;
        });
      }

      function addSection(title) {
        yPosition += 10;
        if (yPosition > pageHeight - 60) {
          doc.addPage();
          yPosition = margin;
        }
        addLine(title, 14, true);
        yPosition += 5;
      }

      const resident = currentResident.resident;
      const spouses = currentResident.spouses || [];
      const children = currentResident.children || [];

      // Title
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('SLUMLINK Resident Report', pageWidth / 2, yPosition, { align: 'center' });
      yPosition += 25;

      // Personal Information
      addSection('Personal Information');
      addLine(`Name: ${resident.full_name || '-'}`);
      addLine(`Slum Code: ${resident.slum_code || '-'}`);
      addLine(`Date of Birth: ${formatDate(resident.dob)}`);
      addLine(`Gender: ${resident.gender || '-'}`);
      addLine(`NID: ${resident.nid || '-'}`);
      addLine(`Mobile: ${resident.mobile || '-'}`);
      addLine(`Education: ${resident.education || '-'}`);
      addLine(`Occupation: ${resident.occupation || '-'}`);
      addLine(`Skills: ${formatSkills(resident)}`);
      addLine(`Income: ${resident.income || '-'}`);
      addLine(`Status: ${resident.status}`);

      // Address Information
      addSection('Address Information');
      addLine(`Area: ${resident.area || '-'}`);
      addLine(`District: ${resident.district || '-'}`);
      addLine(`Division: ${resident.division || '-'}`);
      addLine(`Family Members: ${resident.family_members || 0}`);

      // Spouses
      if (spouses.length > 0) {
        addSection(`Spouse Information (${spouses.length})`);
        spouses.forEach((spouse, idx) => {
          addLine(`Spouse ${idx + 1}:`, 12, true);
          addLine(`  Name: ${spouse.name || '-'}`);
          addLine(`  Date of Birth: ${formatDate(spouse.dob)}`);
          addLine(`  Gender: ${spouse.gender || '-'}`);
          addLine(`  NID: ${spouse.nid || '-'}`);
          addLine(`  Education: ${spouse.education || '-'}`);
          addLine(`  Job: ${spouse.job || '-'}`);
          addLine(`  Skills: ${formatSkills(spouse)}`);
          addLine(`  Income: ${spouse.income || '-'}`);
          addLine(`  Mobile: ${spouse.mobile || '-'}`);
          yPosition += 5;
        });
      }

      // Children
      if (children.length > 0) {
        addSection(`Children Information (${children.length})`);
        children.forEach((child, idx) => {
          addLine(`Child ${idx + 1}:`, 12, true);
          addLine(`  Name: ${child.name || '-'}`);
          addLine(`  Birth Certificate No.: ${child.birth_certificate_number || '-'}`);
          addLine(`  Date of Birth: ${formatDate(child.dob)}`);
          addLine(`  Gender: ${child.gender || '-'}`);
          addLine(`  Education: ${child.education || '-'}`);
          addLine(`  Job: ${child.job || '-'}`);
          addLine(`  Skills: ${formatSkills(child)}`);
          addLine(`  Income: ${child.income || '-'}`);
          addLine(`  Preferred Job: ${child.preferred_job || '-'}`);
          yPosition += 5;
        });
      }

      // Footer
      yPosition = pageHeight - 30;
      doc.setFontSize(10);
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(150);
      doc.text('Generated by SLUMLINK', margin, yPosition);

      doc.save(`${resident.full_name}_Resident_Report.pdf`);
    }
  </script>
</body>
</html>
