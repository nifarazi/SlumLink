<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SLUMLINK Dashboard</title>
  <link rel="stylesheet" href="adminSlumAnalytics.css" />
  <!-- Poppins font for this project -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    .page-title {
      font-size: 24px;
      font-weight: 600;
      color: #8b6f5a;
      margin-bottom: 20px;
    }

    .aid-section,
    .development-section {
      background: #ffffff;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 18px;
      box-shadow: 0 2px 6px rgba(90, 74, 66, 0.08);
      border: 1px solid #efe6db;
    }

    .chart-stack {
      display: grid;
      gap: 12px;
      margin-top: 12px;
    }

    .chart-row {
      display: grid;
      grid-template-columns: 140px 1fr 50px;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: #6b5b4b;
      background: #ffffff;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #efe6db;
    }

    .chart-bar {
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, #8b6f5a, #d4b5a0);
      min-width: 6px;
    }

    .chart-value {
      text-align: right;
      font-weight: 600;
      color: #5a4a42;
    }

    .donut-wrap {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 16px;
      align-items: center;
      margin-top: 12px;
    }

    .donut-legend {
      display: grid;
      gap: 10px;
      font-size: 13px;
      color: #6b5b4b;
    }

    .donut-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #ffffff;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #efe6db;
    }

    .donut-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .stacked-bar {
      height: 14px;
      border-radius: 999px;
      overflow: hidden;
      display: flex;
      background: #f3eee8;
      margin-top: 10px;
    }

    .stacked-segment {
      height: 100%;
    }

    .stacked-legend {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 6px 12px;
      font-size: 12px;
      color: #6b5b4b;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
   <header class="topbar" aria-label="Header">
  <!-- Brand / Logo -->
  <div class="brand clickable" id="brandBtn" aria-label="SlumLink Home" role="button" tabindex="0">
    <img src="/src/images/slum Logo.png" alt="SlumLink Logo" class="logo-mark" />
    <div class="brand-text">SLUMLINK</div>
  </div>

  <!-- Search input -->
  <input type="text" placeholder="Search" class="search" />

  <!-- Admin & Notifications -->
  <div class="top-right">
    <div class="admin">
      <span>Admin ‚ñæ</span>
      <div class="admin-dropdown">
        <button class="admin-logout" id="logoutBtn" type="button" aria-label="Log out">
          Logout
        </button>
      </div>
    </div>
    <div class="notification-bell-container">
      <a class="bell" href="adminNotification.html" title="Notifications">üîî</a>
      <span class="notification-badge" id="notificationBadge">0</span>
    </div>
  </div>
</header>

  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <ul>
          <li class="active"><a href="adminSlumAnalytics.html">üìä Slum Analytics</a></li>
          <li><a href="adminNgoAnalytics.html">üìà NGO Analytics</a></li>
          <li><a href="adminslumdivision.html">üè† Slum Residents</a></li>
          <li><a href="adminFieldAgents.html">üßë‚Äçüíº Field Agents</a></li>
          <li><a href="adminactivengo.html">‚úÖ Active NGOs</a></li>
          <li><a href="adminlocalauthority.html">üèõ Local Authority</a></li>
          <li><a href="adminVerifyNgo.html">‚úî Verify NGOs</a></li>
          <li><a href="adminviewcomplaints.html">üìã View Complaints</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="content">
      <h1 class="page-title" id="slumTitle"></h1>
      <div class="main-grid">
        <div class="left-column">
          <section class="aid-section">
            <div class="aid-header">
              <h2>Aid Distribution</h2>
              <div class="date-range">By campaign category</div>
            </div>
            <div id="aidTable"></div>
            <div id="aidChart" class="chart-stack"></div>
          </section>

          <section class="development-section">
            <div class="development-header"><h2>Population Breakdown</h2></div>
            <div id="populationTable"></div>
            <div id="populationChart" class="chart-stack"></div>
          </section>

          <section class="development-section">
            <div class="development-header"><h2>Top Education</h2></div>
            <div id="educationTable"></div>
            <div id="educationChart" class="chart-stack"></div>
          </section>

          <section class="development-section">
            <div class="development-header"><h2>Top Occupations</h2></div>
            <div id="occupationTable"></div>
            <div id="occupationChart" class="chart-stack"></div>
          </section>

          <section class="development-section">
            <div class="development-header"><h2>Complaints</h2></div>
            <div id="complaintsTable"></div>
            <div id="complaintsChart" class="chart-stack"></div>
          </section>

        </div>

        <aside class="right-sidebar">
          <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">Households</div><div class="stat-value" id="householdsValue">0</div></div>
            <div class="stat-card"><div class="stat-label">Population</div><div class="stat-value" id="populationValue">0</div></div>
            <div class="stat-card"><div class="stat-label">Active Projects</div><div class="stat-value" id="projectsValue">0</div></div>
          </div>

          <div class="urgent-card">
            <div class="urgent-label">Urgent Issues</div>
            <div class="urgent-subtitle" id="urgentCategory">No complaints</div>
            <div class="urgent-value" id="urgentValue">0</div>
          </div>

          <div class="growth-card">
            <div class="growth-label">Total Complaints</div>
            <div class="growth-value" id="complaintsTotalValue">0</div>
            <div class="urgent-subtitle">All complaint records for this slum</div>
          </div>

          <button class="btn-primary" id="exportBtn">Generate Report</button>
          <button class="btn-secondary" id="goBackBtn">Go Back</button>
        </aside>
      </div>
    </main>
  </div>
  <!-- logout modal markup -->
  <div class="modal-overlay" id="logoutModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="logoutTitle">
      <div class="modal-header" id="logoutTitle">Log out</div>
      <div class="modal-body">You're currently signed in as Admin. Do you want to log out and return to the home page?</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelLogout">Cancel</button>
        <button class="btn btn-primary" id="confirmLogout">Log out</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="adminSlumAnalytics.js"></script>
  <script>
    var analyticsData = null;

    // Make each .card button navigate to the show page for that slum.
    // Adds ?slum=Name so the show page can read which slum to display.
    document.addEventListener('DOMContentLoaded', function () {
      // Display Slum name from URL parameter
      var slumName = new URLSearchParams(window.location.search).get('slum');
      var slumTitle = document.getElementById('slumTitle');
      if (slumTitle && slumName) {
        slumTitle.textContent = slumName + ' Analytics';
      }

      function renderTable(containerId, headers, rows) {
        var container = document.getElementById(containerId);
        if (!container) return;

        if (!rows || rows.length === 0) {
          container.innerHTML = '<div style="color:#8b6f5a;">No data available.</div>';
          return;
        }

        var html = '<table class="active-table" style="width:100%;"><thead><tr>';
        headers.forEach(function (header) {
          html += '<th>' + header + '</th>';
        });
        html += '</tr></thead><tbody>';

        rows.forEach(function (row) {
          html += '<tr>' + row.map(function (cell) {
            return '<td>' + cell + '</td>';
          }).join('') + '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      }

      function renderBarChart(containerId, items) {
        var container = document.getElementById(containerId);
        if (!container) return;

        if (!items || items.length === 0) {
          container.innerHTML = '';
          return;
        }

        var maxValue = Math.max.apply(null, items.map(function (item) { return item.value; }));
        if (!maxValue || maxValue <= 0) {
          container.innerHTML = '';
          return;
        }

        var html = '';
        items.forEach(function (item) {
          var width = Math.max(6, Math.round((item.value / maxValue) * 100));
          html += '<div class="chart-row">' +
            '<div>' + item.label + '</div>' +
            '<div class="chart-bar" style="width:' + width + '%"></div>' +
            '<div class="chart-value">' + item.value + '</div>' +
            '</div>';
        });

        container.innerHTML = html;
      }

      function renderDonut(containerId, items) {
        var container = document.getElementById(containerId);
        if (!container) return;

        if (!items || items.length === 0) {
          container.innerHTML = '';
          return;
        }

        var total = items.reduce(function (sum, item) { return sum + item.value; }, 0);
        if (!total) {
          container.innerHTML = '';
          return;
        }

        var palette = ['#8b6f5a', '#d4b5a0', '#ad7562', '#5a4a42', '#c6a07b', '#8f9aa3', '#4f6d7a'];
        var radius = 54;
        var circumference = 2 * Math.PI * radius;
        var offset = 0;

        var svg = '<svg width="140" height="140" viewBox="0 0 140 140">';
        svg += '<circle cx="70" cy="70" r="54" fill="transparent" stroke="#f3eee8" stroke-width="16"></circle>';

        items.forEach(function (item, index) {
          var value = item.value;
          var dash = (value / total) * circumference;
          var color = palette[index % palette.length];
          svg += '<circle cx="70" cy="70" r="54" fill="transparent" stroke="' + color + '" stroke-width="16" stroke-dasharray="' + dash + ' ' + (circumference - dash) + '" stroke-dashoffset="' + (-offset) + '" stroke-linecap="round" transform="rotate(-90 70 70)"></circle>';
          offset += dash;
        });

        svg += '</svg>';

        var legend = '<div class="donut-legend">' + items.map(function (item, index) {
          var color = palette[index % palette.length];
          var percent = Math.round((item.value / total) * 100);
          return '<div class="donut-legend-item"><span class="donut-dot" style="background:' + color + '"></span>' + item.label + ' (' + percent + '%)</div>';
        }).join('') + '</div>';

        container.innerHTML = '<div class="donut-wrap">' + svg + legend + '</div>';
      }

      function renderStackedBar(containerId, items) {
        var container = document.getElementById(containerId);
        if (!container) return;

        if (!items || items.length === 0) {
          container.innerHTML = '';
          return;
        }

        var total = items.reduce(function (sum, item) { return sum + item.value; }, 0);
        if (!total) {
          container.innerHTML = '';
          return;
        }

        var palette = ['#8b6f5a', '#d4b5a0', '#ad7562', '#5a4a42', '#c6a07b'];
        var bar = '<div class="stacked-bar">' + items.map(function (item, index) {
          var width = Math.max(2, Math.round((item.value / total) * 100));
          var color = palette[index % palette.length];
          return '<div class="stacked-segment" style="width:' + width + '%; background:' + color + '"></div>';
        }).join('') + '</div>';

        var legend = '<div class="stacked-legend">' + items.map(function (item, index) {
          var color = palette[index % palette.length];
          return '<div class="donut-legend-item"><span class="donut-dot" style="background:' + color + '"></span>' + item.label + ': ' + item.value + '</div>';
        }).join('') + '</div>';

        container.innerHTML = bar + legend;
      }

      function getCountByStatus(rows, status) {
        var match = rows.find(function (row) { return row.status === status; });
        return match ? match.count : 0;
      }

      function loadAnalytics() {
        if (!slumName) return;

        fetch('/api/slum-dweller/analytics?slum=' + encodeURIComponent(slumName))
          .then(function (response) { return response.json(); })
          .then(function (result) {
            if (result.status !== 'success') throw new Error(result.message || 'Failed to load analytics');

            analyticsData = result.data;

            document.getElementById('householdsValue').textContent = analyticsData.households || 0;
            document.getElementById('populationValue').textContent = analyticsData.population || 0;
            document.getElementById('projectsValue').textContent = analyticsData.activeProjects || 0;

            var pendingComplaints = getCountByStatus(analyticsData.complaintsByStatus || [], 'pending');
            var complaintCategories = analyticsData.complaintsByCategory || [];
            if (complaintCategories.length > 0) {
              var maxCount = Math.max.apply(null, complaintCategories.map(function (row) { return row.count; }));
              var tied = complaintCategories.filter(function (row) { return row.count === maxCount; });
              var label = tied.map(function (row) {
                return row.category + ' (' + row.count + ')';
              }).join(', ');
              document.getElementById('urgentValue').textContent = maxCount;
              document.getElementById('urgentCategory').textContent = label;
            } else {
              document.getElementById('urgentValue').textContent = 0;
              document.getElementById('urgentCategory').textContent = 'No complaints';
            }

            document.getElementById('complaintsTotalValue').textContent = analyticsData.complaintsTotal || 0;

            renderTable('aidTable', ['Category', 'Count'],
              (analyticsData.aidByCategory || []).map(function (row) {
                return [row.category || 'Unknown', row.count || 0];
              })
            );

            renderDonut('aidChart', (analyticsData.aidByCategory || []).map(function (row) {
              return { label: row.category || 'Unknown', value: row.count || 0 };
            }));

            renderTable('populationTable', ['Metric', 'Count'], [
              ['Adults', analyticsData.adults || 0],
              ['Children', analyticsData.children || 0],
              ['Male', (analyticsData.gender || {}).Male || 0],
              ['Female', (analyticsData.gender || {}).Female || 0],
              ['Others', (analyticsData.gender || {}).Others || 0]
            ]);

            renderStackedBar('populationChart', [
              { label: 'Adults', value: analyticsData.adults || 0 },
              { label: 'Children', value: analyticsData.children || 0 },
              { label: 'Male', value: (analyticsData.gender || {}).Male || 0 },
              { label: 'Female', value: (analyticsData.gender || {}).Female || 0 },
              { label: 'Others', value: (analyticsData.gender || {}).Others || 0 }
            ]);

            renderTable('educationTable', ['Education', 'Count'],
              (analyticsData.educationTop || []).map(function (row) {
                return [row.education || 'Unknown', row.count || 0];
              })
            );

            renderDonut('educationChart', (analyticsData.educationTop || []).map(function (row) {
              return { label: row.education || 'Unknown', value: row.count || 0 };
            }));

            renderTable('occupationTable', ['Occupation', 'Count'],
              (analyticsData.occupationTop || []).map(function (row) {
                return [row.occupation || 'Unknown', row.count || 0];
              })
            );

            renderDonut('occupationChart', (analyticsData.occupationTop || []).map(function (row) {
              return { label: row.occupation || 'Unknown', value: row.count || 0 };
            }));

            renderTable('complaintsTable', ['Status', 'Count'],
              (analyticsData.complaintsByStatus || []).map(function (row) {
                return [row.status || 'Unknown', row.count || 0];
              })
            );

            renderDonut('complaintsChart', (analyticsData.complaintsByStatus || []).map(function (row) {
              return { label: row.status || 'Unknown', value: row.count || 0 };
            }));

          })
          .catch(function (error) {
            console.error('Error loading analytics:', error);
          });
      }

      loadAnalytics();
      
      var cards = document.querySelectorAll('.card');
      cards.forEach(function (card) {
        card.addEventListener('click', function () {
          var name = (card.textContent || '').trim();
          var target = 'adminShowSlumAnalytics.html';
          if (name) {
            target += '?slum=' + encodeURIComponent(name);
          }
          window.location.href = target;
        });
        // make keyboard accessible
        card.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            card.click();
          }
        });
      });

      // Export Report button - generates and downloads a PDF report
      var exportBtn = document.getElementById('exportBtn');
      if (exportBtn) {
        exportBtn.addEventListener('click', function () {
          var jsPDFCtor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
          if (!jsPDFCtor) { alert('PDF library not loaded'); return; }
          
          var slumName = new URLSearchParams(window.location.search).get('slum') || 'Slum Report';
          var reportData = analyticsData || {};
          var doc = new jsPDFCtor({ unit: 'mm', format: 'a4' });
          
          var pageWidth = doc.internal.pageSize.getWidth();
          var margin = 15;
          var contentWidth = pageWidth - 2 * margin;
          var y = margin;
          var lineGap = 6;
          var sectionGap = 8;

          function addSectionTitle(text) {
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(90, 74, 66);
            doc.text(text, margin, y);
            y += lineGap;
            doc.setDrawColor(210, 197, 183);
            doc.line(margin, y, pageWidth - margin, y);
            y += sectionGap;
          }

          function addKeyValue(label, value) {
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(60);
            doc.text(label + ': ' + value, margin, y);
            y += lineGap;
          }

          function addList(title, items) {
            addSectionTitle(title);
            if (!items || items.length === 0) {
              addKeyValue('No data available', '');
              return;
            }
            items.forEach(function (item) {
              if (y > 270) {
                doc.addPage();
                y = margin;
              }
              doc.setFontSize(10);
              doc.setFont('helvetica', 'normal');
              doc.setTextColor(60);
              doc.text('- ' + item, margin, y);
              y += lineGap;
            });
          }

          function drawBarChart(items) {
            if (!items || items.length === 0) return;
            var maxValue = Math.max.apply(null, items.map(function (item) { return item.value; }));
            if (!maxValue || maxValue <= 0) return;

            var barWidth = contentWidth - 30;
            var barHeight = 5;

            items.forEach(function (item) {
              if (y > 270) {
                doc.addPage();
                y = margin;
              }

              var ratio = item.value / maxValue;
              var width = Math.max(10, Math.round(barWidth * ratio));

              doc.setFontSize(9);
              doc.setFont('helvetica', 'normal');
              doc.setTextColor(90);
              doc.text(item.label, margin, y + 4);

              doc.setFillColor(239, 230, 219);
              doc.rect(margin + 30, y, barWidth, barHeight, 'F');

              doc.setFillColor(139, 111, 90);
              doc.rect(margin + 30, y, width, barHeight, 'F');

              doc.setFontSize(9);
              doc.setTextColor(60);
              doc.text(String(item.value), margin + 30 + barWidth + 4, y + 4);

              y += barHeight + 5;
            });

            y += 3;
          }

          function drawStackedBar(items) {
            if (!items || items.length === 0) return;
            var total = items.reduce(function (sum, item) { return sum + item.value; }, 0);
            if (!total) return;

            var barWidth = contentWidth;
            var barHeight = 6;
            var startX = margin;

            if (y > 270) {
              doc.addPage();
              y = margin;
            }

            var colors = [
              [139, 111, 90],
              [212, 181, 160],
              [173, 117, 98],
              [90, 74, 66],
              [198, 160, 123]
            ];

            items.forEach(function (item, index) {
              var width = Math.max(4, Math.round((item.value / total) * barWidth));
              var color = colors[index % colors.length];
              doc.setFillColor(color[0], color[1], color[2]);
              doc.rect(startX, y, width, barHeight, 'F');
              startX += width;
            });

            y += barHeight + 4;

            items.forEach(function (item, index) {
              if (y > 270) {
                doc.addPage();
                y = margin;
              }
              var color = colors[index % colors.length];
              doc.setFillColor(color[0], color[1], color[2]);
              doc.rect(margin, y, 4, 4, 'F');
              doc.setFontSize(9);
              doc.setTextColor(60);
              doc.text(item.label + ': ' + item.value, margin + 6, y + 4);
              y += 5;
            });

            y += 3;
          }
          
          // Title
          doc.setFontSize(18);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(90, 74, 66);
          doc.text('SLUMLINK Slum Analytics Report', pageWidth / 2, y, { align: 'center' });
          y += 15;
          
          // Slum Name
          doc.setFontSize(14);
          doc.setFont('helvetica', 'bold');
          doc.text(slumName + ' Overview', margin, y);
          y += 10;
          
          // Generated Date
          doc.setFontSize(10);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(90);
          doc.text('Generated on: ' + new Date().toLocaleString(), margin, y);
          y += 10;

          addSectionTitle('Key Statistics');
          addKeyValue('Households', reportData.households || 0);
          addKeyValue('Population', reportData.population || 0);
          addKeyValue('Active Projects', reportData.activeProjects || 0);

          var adults = reportData.adults || 0;
          var children = reportData.children || 0;
          addKeyValue('Adults', adults);
          addKeyValue('Children', children);

          var gender = reportData.gender || {};
          addKeyValue('Male', gender.Male || 0);
          addKeyValue('Female', gender.Female || 0);
          addKeyValue('Others', gender.Others || 0);

          var aidRows = reportData.aidByCategory || [];
          addList('Aid Distribution', aidRows.map(function (row) {
            return (row.category || 'Unknown') + ': ' + (row.count || 0);
          }));
          drawBarChart(aidRows.map(function (row) {
            return { label: row.category || 'Unknown', value: row.count || 0 };
          }));

          var educationRows = reportData.educationTop || [];
          addList('Top Education', educationRows.map(function (row) {
            return (row.education || 'Unknown') + ': ' + (row.count || 0);
          }));

          var occupationRows = reportData.occupationTop || [];
          addList('Top Occupations', occupationRows.map(function (row) {
            return (row.occupation || 'Unknown') + ': ' + (row.count || 0);
          }));

          var complaintRows = reportData.complaintsByStatus || [];
          addList('Complaints by Status', complaintRows.map(function (row) {
            return (row.status || 'Unknown') + ': ' + (row.count || 0);
          }));
          drawBarChart(complaintRows.map(function (row) {
            return { label: row.status || 'Unknown', value: row.count || 0 };
          }));

          var categoryRows = reportData.complaintsByCategory || [];
          addList('Top Complaint Categories', categoryRows.map(function (row) {
            return (row.category || 'Unknown') + ': ' + (row.count || 0);
          }));

          drawStackedBar([
            { label: 'Adults', value: reportData.adults || 0 },
            { label: 'Children', value: reportData.children || 0 }
          ]);
          
          // Save PDF
          var filename = slumName.replace(/[^a-z0-9]+/gi, '_').toLowerCase() + '_report.pdf';
          doc.save(filename);
        });
      }

      // Go Back button - returns to admin analytics dashboard
      var goBackBtn = document.getElementById('goBackBtn');
      if (goBackBtn) {
        goBackBtn.addEventListener('click', function () {
          window.location.href = 'adminSlumAnalytics.html';
        });
      }
    });
  </script>
</body>
</html>
