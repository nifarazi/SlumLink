<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SLUMLINK ¬∑ Notifications</title>
  <link rel="stylesheet" href="adminSlumAnalytics.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
 <header class="topbar" aria-label="Header">
  <!-- Brand / Logo -->
  <div class="brand clickable" id="brandBtn" aria-label="SlumLink Home" role="button" tabindex="0">
    <img src="/src/images/slum Logo.png" alt="SlumLink Logo" class="logo-mark" />
    <div class="brand-text">SLUMLINK</div>
  </div>

  <!-- Search input -->
  <input type="text" placeholder="Search" class="search" />

  <!-- Admin & Notifications -->
  <div class="top-right">
    <div class="admin">
      <span>Admin ‚ñæ</span>
      <div class="admin-dropdown">
        <!-- ‚úÖ Logout button -->
        <button class="admin-logout" id="logoutBtn" type="button" aria-label="Log out">
          Logout
        </button>
      </div>
    </div>
    <div class="notification-bell-container">
      <a class="bell" href="adminNotification.html" title="Notifications">üîî</a>
      <span class="notification-badge" id="notificationBadge">0</span>
    </div>
  </div>
</header>


  <div class="container">
    <aside class="sidebar">
      <ul>
        <li><a href="adminSlumAnalytics.html">üìä Slum Analytics</a></li>
        <li><a href="adminNgoAnalytics.html">üìà NGO Analytics</a></li>
        <li><a href="adminslumdivision.html">üè† Slum Residents</a></li>
        <li><a href="adminFieldAgents.html">üßë‚Äçüíº Field Agents</a></li>
        <li><a href="adminactivengo.html">‚úÖ Active NGOs</a></li>
        <li><a href="adminlocalauthority.html">üèõ Local Authority</a></li>
        <li><a href="adminVerifyNgo.html">‚úî Verify NGOs</a></li>
        <li><a href="adminviewcomplaints.html">üìã View Complaints</a></li>
      </ul>
    </aside>

    <main class="content">
      <div class="page-header">
        <div>
        </div>
      </div>

      <div class="table-card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2>Notifications</h2>
            <p>Recent alerts and updates from the system.</p>
          </div>
          <div class="sort-dropdown" style="position: relative;">
            <button id="sortBtn" style="background-color: #8b6f5a; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: 600; font-family: Poppins; font-size: 14px;">Sort by ‚ñº</button>
            <div id="sortMenu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #e0d5c7; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 100; min-width: 200px; margin-top: 5px;">
              <button class="sort-option" data-sort="latest" style="display: block; width: 100%; text-align: left; padding: 12px 15px; border: none; background: none; cursor: pointer; color: #6b5b4b; font-family: Poppins; font-size: 14px; border-bottom: 1px solid #e0d5c7;" onmouseover="this.style.backgroundColor='#f5f0e8'" onmouseout="this.style.backgroundColor='transparent'">Latest to Oldest</button>
              <button class="sort-option" data-sort="oldest" style="display: block; width: 100%; text-align: left; padding: 12px 15px; border: none; background: none; cursor: pointer; color: #6b5b4b; font-family: Poppins; font-size: 14px;" onmouseover="this.style.backgroundColor='#f5f0e8'" onmouseout="this.style.backgroundColor='transparent'">Oldest to Latest</button>
            </div>
          </div>
        </div>
        <div style="padding: 20px;">
          <div id="notificationsList" style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Notifications will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="modal-overlay" id="logoutModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="logoutTitle">
      <div class="modal-header" id="logoutTitle">Log out</div>
      <div class="modal-body">You're currently signed in as Admin. Do you want to log out and return to the home page?</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelLogout">Cancel</button>
        <button class="btn btn-primary" id="confirmLogout">Log out</button>
      </div>
    </div>
  </div>

  <script src="adminSlumAnalytics.js"></script>
  <script>
    var currentSort = 'latest';
    
    var notifications = [];

    function timeToMinutes(timeStr) {
      if (!timeStr) return 0;
      if (timeStr.toLowerCase() === 'just now') return 0;
      var multipliers = {
        'minute': 1,
        'hour': 60,
        'day': 24 * 60,
        'week': 7 * 24 * 60,
        'month': 30 * 24 * 60
      };
      var parts = timeStr.split(' ');
      var num = parseInt(parts[0]);
      if (Number.isNaN(num) || parts.length < 2) return 0;
      var unit = parts[1].toLowerCase();
      
      if (unit.includes('hour')) return num * multipliers.hour;
      if (unit.includes('minute')) return num * multipliers.minute;
      if (unit.includes('day')) return num * multipliers.day;
      if (unit.includes('week')) return num * multipliers.week;
      if (unit.includes('month')) return num * multipliers.month;
      return 0;
    }

    function formatRelativeTime(dateValue) {
      if (!dateValue) return 'Just now';
      var date = new Date(dateValue);
      if (isNaN(date)) return 'Just now';

      var diffMs = Date.now() - date.getTime();
      var diffMinutes = Math.floor(diffMs / 60000);
      if (diffMinutes <= 0) return 'Just now';
      if (diffMinutes < 60) return diffMinutes + ' minutes ago';
      var diffHours = Math.floor(diffMinutes / 60);
      if (diffHours < 24) return diffHours + ' hours ago';
      var diffDays = Math.floor(diffHours / 24);
      return diffDays + ' days ago';
    }

    var dismissedKey = 'slumlink_dismissed_notifications';

    function loadDismissed() {
      try {
        var raw = localStorage.getItem(dismissedKey);
        return raw ? JSON.parse(raw) : [];
      } catch (error) {
        console.warn('Local storage not available:', error);
        return [];
      }
    }

    function saveDismissed(keys) {
      try {
        localStorage.setItem(dismissedKey, JSON.stringify(keys));
      } catch (error) {
        console.warn('Local storage not available:', error);
      }
    }

    // Clear all dismissed notifications on page load
    localStorage.removeItem(dismissedKey);

    function makeNotificationKey(notif) {
      return [notif.type, notif.message, notif.link].join('|');
    }

    var dismissedNotifications = loadDismissed();

    function prependNotifications(items) {
      if (!items || items.length === 0) return;
      var stamped = items.map(function(item) {
        if (!item._id) {
          item._id = 'notif_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8);
        }
        return item;
      });
      var filtered = stamped.filter(function(item) {
        return dismissedNotifications.indexOf(makeNotificationKey(item)) === -1;
      });
      notifications = filtered.concat(notifications);
      renderNotifications();
    }
    
    function sortNotifications() {
      var sorted = notifications.slice();
      sorted.sort(function(a, b) {
        var timeA = timeToMinutes(a.time);
        var timeB = timeToMinutes(b.time);
        
        if (currentSort === 'latest') {
          return timeA - timeB;
        } else {
          return timeB - timeA;
        }
      });
      return sorted;
    }
    
    function renderNotifications() {
      var container = document.getElementById('notificationsList');
      container.innerHTML = '';
      
      var sortedNotifications = sortNotifications();

      // Update badge to match displayed notifications
      var badgeElement = document.getElementById('notificationBadge');
      if (badgeElement) {
        badgeElement.textContent = sortedNotifications.length;
        badgeElement.style.display = sortedNotifications.length > 0 ? 'flex' : 'none';
      }

      if (sortedNotifications.length === 0) {
        var empty = document.createElement('div');
        empty.style.textAlign = 'center';
        empty.style.color = '#8b6f5a';
        empty.style.padding = '20px';
        empty.textContent = 'No notifications at this time.';
        container.appendChild(empty);
        return;
      }

      sortedNotifications.forEach(function(notif) {
        var notifBox = document.createElement('div');
        notifBox.style.cssText = 'border: 1px solid #e0d5c7; border-radius: 8px; padding: 15px; background-color: #fafaf8; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center;';
        notifBox.onmouseover = function() {
          notifBox.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
          notifBox.style.backgroundColor = '#f5f0e8';
        };
        notifBox.onmouseout = function() {
          notifBox.style.boxShadow = 'none';
          notifBox.style.backgroundColor = '#fafaf8';
        };
        
        var contentDiv = document.createElement('div');
        contentDiv.style.flex = '1';
        
        var typeSpan = document.createElement('span');
        typeSpan.textContent = notif.icon + ' ' + notif.type;
        typeSpan.style.cssText = 'font-weight: 600; color: #5a4a3a; font-size: 14px; display: block; margin-bottom: 5px;';
        contentDiv.appendChild(typeSpan);
        
        var messageSpan = document.createElement('span');
        messageSpan.textContent = notif.message;
        messageSpan.style.cssText = 'color: #6b5b4b; font-size: 14px; display: block; margin-bottom: 5px;';
        contentDiv.appendChild(messageSpan);
        
        var timeSpan = document.createElement('span');
        timeSpan.textContent = notif.time;
        timeSpan.style.cssText = 'color: #a89a8a; font-size: 12px;';
        contentDiv.appendChild(timeSpan);
        
        notifBox.appendChild(contentDiv);
        
        notifBox.onclick = function() {
          var key = makeNotificationKey(notif);
          if (dismissedNotifications.indexOf(key) === -1) {
            dismissedNotifications.push(key);
            saveDismissed(dismissedNotifications);
          }
          notifications = notifications.filter(function(item) {
            return item._id !== notif._id;
          });
          renderNotifications();
          setTimeout(function () {
            window.location.href = notif.link;
          }, 50);
        };
        
        container.appendChild(notifBox);
      });
    }

    renderNotifications();

    async function loadUpdateNotifications() {
      try {
        const response = await fetch('/api/slum-dweller/active');
        const result = await response.json();

        if (result.status !== 'success') return;

        const updates = (result.data || [])
          .filter(function(account) {
            const updateCount = Number(account.spouse_updates || 0) + Number(account.child_updates || 0);
            return updateCount > 0;
          })
          .map(function(account) {
            return {
              type: 'Active Resident',
              message: 'Resident "' + (account.full_name || 'Unknown') + '" from "' + (account.area || '-') + '" has submitted family member updates for review.',
              icon: 'üìÑ',
              time: 'Just now',
              link: 'SlumResidentsInfo.html?id=' + account.id
            };
          });

        prependNotifications(updates);
      } catch (error) {
        console.error('Error loading update notifications:', error);
      }
    }

    loadUpdateNotifications();

    async function loadPendingNgoNotifications() {
      try {
        const response = await fetch('/api/ngo/pending');
        const result = await response.json();

        if (!result || result.status !== 'success') return;

        const pending = (result.data || []).map(function(ngo) {
          return {
            type: 'NGO Signup',
            message: 'New NGO "' + (ngo.org_name || 'Unknown') + '" has signed up and is awaiting verification.',
            icon: 'üìã',
            time: formatRelativeTime(ngo.created_at),
            link: 'adminVerifyNgo.html'
          };
        });

        prependNotifications(pending);
      } catch (error) {
        console.error('Error loading NGO notifications:', error);
      }
    }

    loadPendingNgoNotifications();

    async function loadPendingSlumNotifications() {
      try {
        const response = await fetch('/api/slum-dweller/pending');
        const result = await response.json();

        if (!result || result.status !== 'success') return;

        const pending = (result.data || []).map(function(account) {
          return {
            type: 'Slum Resident',
            message: 'New pending account "' + (account.full_name || 'Unknown') + '" from slum "' + (account.area || '-') + '" awaiting verification.',
            icon: 'üë§',
            time: formatRelativeTime(account.created_at),
            link: 'SlumPendingAccounts.html?slum=' + encodeURIComponent(account.area || '')
          };
        });

        prependNotifications(pending);
      } catch (error) {
        console.error('Error loading slum dweller notifications:', error);
      }
    }

    loadPendingSlumNotifications();

    async function loadCampaignNotifications() {
      try {
        const response = await fetch('/api/campaigns');
        const result = await response.json();

        if (!result || result.success !== true) return;

        const campaigns = (result.data || []).slice(0, 10).map(function(campaign) {
          var isLocal = String(campaign.org_type || '').toLowerCase() === 'localauthority';
          var typeLabel = isLocal ? 'Local Authority Campaign' : 'NGO Campaign';
          var icon = isLocal ? 'üèõ' : 'üì¢';
          var orgName = campaign.org_name || 'Organization';
            var link = isLocal
              ? 'adminlocalcampaigninfo.html?org=' + encodeURIComponent(orgName)
              : 'adminactivengoinfo.html?ngo=' + encodeURIComponent(orgName);

          return {
            type: typeLabel,
            message: 'New campaign "' + (campaign.title || 'Untitled') + '" created by ' + orgName + ' in "' + (campaign.slum_area || '-') + '".',
            icon: icon,
            time: formatRelativeTime(campaign.created_at),
            link: link
          };
        });

        prependNotifications(campaigns);
      } catch (error) {
        console.error('Error loading campaign notifications:', error);
      }
    }

    loadCampaignNotifications();
    
    document.getElementById('sortBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      var menu = document.getElementById('sortMenu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    });
    
    document.querySelectorAll('.sort-option').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        currentSort = this.getAttribute('data-sort');
        document.getElementById('sortMenu').style.display = 'none';
        renderNotifications();
      });
    });
    
    document.addEventListener('click', function() {
      document.getElementById('sortMenu').style.display = 'none';
    });
  </script>
</html>
