<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SLUMLINK ¬∑ Active Slum Resident Accounts</title>
  <link rel="stylesheet" href="adminSlumAnalytics.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    .active-table th:last-child,
    .active-table td:last-child {
      text-align: left;
      padding-right: 0;
    }

    .active-table th:last-child {
      text-align: right;
      padding-right: 100px;
    }

    .active-actions {
      display: flex;
      justify-content: flex-start;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-view {
      background-color: #8b6f5a !important;
      color: white !important;
      border: none !important;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-view:hover {
      background-color: #6b5744 !important;
    }

    .btn-delete {
      background-color: rgba(180, 80, 80, 0.2) !important;
      color: #a83e3e !important;
      border: none !important;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-delete:hover {
      background-color: rgba(180, 80, 80, 0.3) !important;
    }

    .card-header h2 {
      color: #8b6f5a;
    }

    .status-badge {
      background: rgba(45, 122, 61, 0.15);
      color: #2d7a3d;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 12px;
    }

    .update-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin-left: 6px;
      border-radius: 50%;
      background: #c0392b;
      box-shadow: 0 0 0 2px rgba(192, 57, 43, 0.15);
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <header class="topbar" aria-label="Header">
    <div class="brand clickable" id="brandBtn" aria-label="SlumLink Home" role="button" tabindex="0">
      <img src="/src/images/slum Logo.png" alt="SlumLink Logo" class="logo-mark" />
      <div class="brand-text">SLUMLINK</div>
    </div>

    <input type="text" placeholder="Search" class="search" />

    <div class="top-right">
      <div class="admin">
        <span>Admin ‚ñæ</span>
        <div class="admin-dropdown">
          <button class="admin-logout" id="logoutBtn" type="button" aria-label="Log out">Logout</button>
        </div>
      </div>
      <div class="notification-bell-container">
        <a class="bell" href="adminNotification.html" title="Notifications">üîî</a>
        <span class="notification-badge" id="notificationBadge">0</span>
      </div>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <ul>
        <li><a href="adminSlumAnalytics.html">üìä Slum Analytics</a></li>
        <li><a href="adminNgoAnalytics.html">üìà NGO Analytics</a></li>
        <li class="active"><a href="adminslumdivision.html">üè† Slum Residents</a></li>
        <li><a href="adminFieldAgents.html">üßë‚Äçüíº Field Agents</a></li>
        <li><a href="adminactivengo.html">‚úÖ Active NGOs</a></li>
        <li><a href="adminlocalauthority.html">üèõ Local Authority</a></li>
        <li><a href="adminVerifyNgo.html">‚úî Verify NGOs</a></li>
        <li><a href="adminviewcomplaints.html">üìã View Complaints</a></li>
      </ul>
    </aside>

    <main class="content">
      <div class="page-header">
        
      </div>

      <div class="table-card">
        <div class="card-header">
          <h2>Active Accounts</h2>
        </div>
        <table class="active-table">
          <thead>
            <tr>
              <th>Full Name</th>
              <th>Slum Code</th>
              <th>Mobile</th>
              <th>Education</th>
              <th>Area</th>
              <th>District</th>
              <th>Division</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="activeTableBody">
            <tr><td colspan="9" style="text-align: center; color: #999;">Loading...</td></tr>
          </tbody>
        </table>
        <div class="footer">
          <span>Showing data</span>
          <div class="pagination" id="pagination"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">Delete Account</div>
      <div class="modal-body" id="deleteModalBody">Are you sure you want to delete this active account?</div>
      <div class="modal-actions">
        <button id="cancelDelete" type="button">Cancel</button>
        <button id="confirmDelete" type="button" style="background-color: #a83e3e; color: white;">Delete</button>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="modal-overlay" id="successModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">Success</div>
      <div class="modal-body" id="successModalBody"></div>
      <div class="modal-actions">
        <button id="closeSuccess" type="button" style="background-color: #2d7a3d; color: white;">Close</button>
      </div>
    </div>
  </div>

  <!-- Logout Modal -->
  <div class="modal-overlay" id="logoutModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="logoutTitle">
      <div class="modal-header" id="logoutTitle">Log out</div>
      <div class="modal-body">You're currently signed in as Admin. Do you want to log out and return to the home page?</div>
      <div class="modal-actions">
        <button id="cancelLogout" type="button">Cancel</button>
        <button id="confirmLogout" type="button" style="background-color: #8b6f5a; color: white;">Log out</button>
      </div>
    </div>
  </div>

  <script src="adminSlumAnalytics.js"></script>
  <script>
    let activeAccounts = [];
    let currentDeleteId = -1;

    document.addEventListener('DOMContentLoaded', async function () {
      const tableBody = document.getElementById('activeTableBody');
      const params = new URLSearchParams(window.location.search);
      const slumParam = (params.get('slum') || '').trim();
      const districtParam = (params.get('district') || '').trim();
      const divisionParam = (params.get('division') || '').trim();

      function normalize(value) {
        return String(value || '').trim().toLowerCase();
      }

      // Fetch active accounts from database
      async function fetchActiveAccounts() {
        try {
          const response = await fetch('/api/slum-dweller/active');
          const result = await response.json();
          if (result.status === 'success') {
            activeAccounts = result.data || [];
            renderRows();
          } else {
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: red;">Failed to load accounts: ' + result.message + '</td></tr>';
          }
        } catch (error) {
          console.error('Error fetching active accounts:', error);
          tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: red;">Error loading accounts. Please try again.</td></tr>';
        }
      }

      function renderRows() {
        tableBody.innerHTML = '';

        const filtered = (activeAccounts || []).filter((account) => {
          if (account.status && normalize(account.status) !== 'accepted') return false;
          if (slumParam && normalize(account.area) !== normalize(slumParam)) return false;
          if (districtParam && normalize(account.district) !== normalize(districtParam)) return false;
          if (divisionParam && normalize(account.division) !== normalize(divisionParam)) return false;
          return true;
        });

        if (filtered.length === 0) {
          const emptyRow = document.createElement('tr');
          const emptyCell = document.createElement('td');
          emptyCell.colSpan = 9;
          emptyCell.style.textAlign = 'center';
          emptyCell.style.color = '#8b6f5a';
          emptyCell.textContent = 'No active accounts.';
          emptyRow.appendChild(emptyCell);
          tableBody.appendChild(emptyRow);
          return;
        }

        filtered.forEach(function (account) {
          const row = document.createElement('tr');
          const updateCount = Number(account.spouse_updates || 0) + Number(account.child_updates || 0);
          const hasUpdates = updateCount > 0;

          // Name
          const nameCell = document.createElement('td');
          nameCell.textContent = account.full_name || 'Unknown';
          if (hasUpdates) {
            const dot = document.createElement('span');
            dot.className = 'update-dot';
            dot.title = 'Pending family updates';
            nameCell.appendChild(dot);
          }
          row.appendChild(nameCell);

          // Slum Code
          const slumCell = document.createElement('td');
          slumCell.textContent = account.slum_code || '‚Äî';
          slumCell.style.fontWeight = 'bold';
          row.appendChild(slumCell);

          // Mobile
          const mobileCell = document.createElement('td');
          mobileCell.textContent = account.mobile || '‚Äî';
          row.appendChild(mobileCell);

          // Education
          const educationCell = document.createElement('td');
          educationCell.textContent = account.education || '‚Äî';
          row.appendChild(educationCell);

          // Area (Slum)
          const areaCell = document.createElement('td');
          areaCell.textContent = account.area || '‚Äî';
          row.appendChild(areaCell);

          // District
          const districtCell = document.createElement('td');
          districtCell.textContent = account.district || '‚Äî';
          row.appendChild(districtCell);

          // Division
          const divisionCell = document.createElement('td');
          divisionCell.textContent = account.division || '‚Äî';
          row.appendChild(divisionCell);

          // Status
          const statusCell = document.createElement('td');
          const statusBadge = document.createElement('span');
          statusBadge.className = 'status-badge';
          statusBadge.textContent = 'Active';
          statusCell.appendChild(statusBadge);
          if (hasUpdates) {
            const dot = document.createElement('span');
            dot.className = 'update-dot';
            dot.title = 'Pending family updates';
            statusCell.appendChild(dot);
          }
          row.appendChild(statusCell);

          // Actions
          const actionsCell = document.createElement('td');
          actionsCell.className = 'active-actions';

          const viewBtn = document.createElement('button');
          viewBtn.textContent = 'View Details';
          viewBtn.className = 'btn-view';
          viewBtn.onclick = () => {
            sessionStorage.setItem('selectedSlumDweller', JSON.stringify(account));
            window.location.href = 'SlumResidentsInfo.html?id=' + account.id;
          };

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.className = 'btn-delete';
          deleteBtn.onclick = () => {
            currentDeleteId = account.id;
            openDeleteModal(account.full_name || 'resident');
          };

          actionsCell.appendChild(viewBtn);
          actionsCell.appendChild(deleteBtn);
          row.appendChild(actionsCell);

          tableBody.appendChild(row);
        });
      }

      // Modal functions
      function openDeleteModal(name) {
        const modal = document.getElementById('deleteModal');
        const body = document.getElementById('deleteModalBody');
        body.textContent = 'Are you sure you want to delete ' + name + '\'s active account and all associated records?';
        modal.setAttribute('aria-hidden', 'false');
        modal.classList.add('show');
      }

      function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.setAttribute('aria-hidden', 'true');
        modal.classList.remove('show');
        currentDeleteId = -1;
      }

      function showSuccessModal(message) {
        const modal = document.getElementById('successModal');
        const body = document.getElementById('successModalBody');
        body.textContent = message;
        modal.setAttribute('aria-hidden', 'false');
        modal.classList.add('show');
      }

      function closeSuccessModal() {
        const modal = document.getElementById('successModal');
        modal.setAttribute('aria-hidden', 'true');
        modal.classList.remove('show');
      }

      // Delete button handler
      document.getElementById('confirmDelete').addEventListener('click', async function() {
        if (currentDeleteId < 0) return;
        
        try {
          const response = await fetch(`/api/slum-dweller/${currentDeleteId}`, {
            method: 'DELETE'
          });
          const result = await response.json();
          
          if (result.status === 'success') {
            closeDeleteModal();
            showSuccessModal('Account deleted successfully.');
            setTimeout(() => {
              closeSuccessModal();
              fetchActiveAccounts(); // Refresh the list
            }, 2000);
          } else {
            alert('Failed to delete: ' + result.message);
          }
        } catch (error) {
          console.error('Error deleting account:', error);
          alert('Error deleting account. Please try again.');
        }
      });

      document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);
      document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) closeDeleteModal();
      });

      document.getElementById('closeSuccess').addEventListener('click', closeSuccessModal);
      document.getElementById('successModal').addEventListener('click', function(e) {
        if (e.target === this) closeSuccessModal();
      });

      // Initial fetch
      fetchActiveAccounts();

      // Refresh data when page is shown (including from back button)
      window.addEventListener('pageshow', function(event) {
        console.log('pageshow event fired, refreshing data');
        fetchActiveAccounts();
      });

      // Mark that we're leaving the page
      window.addEventListener('beforeunload', function() {
        sessionStorage.setItem('leftSlumActiveAccounts', 'true');
      });

      // Check if we just returned from another page
      if (sessionStorage.getItem('leftSlumActiveAccounts') === 'true') {
        sessionStorage.removeItem('leftSlumActiveAccounts');
        setTimeout(function() {
          console.log('Returned from details page, refreshing');
          fetchActiveAccounts();
        }, 500);
      }
    });
  </script>
</body>
</html>
