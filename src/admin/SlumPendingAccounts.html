<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SLUMLINK ¬∑ Pending Slum Residents</title>
  <link rel="stylesheet" href="adminSlumAnalytics.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    .pending-table th:last-child,
    .pending-table td:last-child {
      text-align: left;
      padding-right: 0;
    }

    .pending-table th:last-child {
      text-align: right;
      padding-right: 120px;
    }

    .pending-actions {
      display: flex;
      justify-content: flex-start;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-approve {
      background-color: rgba(45, 122, 61, 0.15) !important;
      color: #2d7a3d !important;
      border: none !important;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-approve:hover {
      background-color: rgba(45, 122, 61, 0.25) !important;
    }

    .btn-reject {
      background-color: rgba(180, 80, 80, 0.2) !important;
      color: #a83e3e !important;
      border: none !important;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-reject:hover {
      background-color: rgba(180, 80, 80, 0.3) !important;
    }

    .btn-view {
      background-color: #8b6f5a !important;
      color: white !important;
      border: none !important;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-view:hover {
      background-color: #6b5744 !important;
    }

    .card-header h2 {
      color: #8b6f5a;
    }

    .btn-approve-primary {
      background-color: #8b6f5a !important;
      color: white !important;
      border: none !important;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .btn-approve-secondary {
      background-color: rgba(139, 111, 90, 0.18) !important;
      color: #6b5744 !important;
      border: 1px solid rgba(139, 111, 90, 0.35) !important;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header class="topbar" aria-label="Header">
    <div class="brand clickable" id="brandBtn" aria-label="SlumLink Home" role="button" tabindex="0">
      <img src="/src/images/slum Logo.png" alt="SlumLink Logo" class="logo-mark" />
      <div class="brand-text">SLUMLINK</div>
    </div>

    <input type="text" placeholder="Search" class="search" />

    <div class="top-right">
      <div class="admin">
        <span>Admin ‚ñæ</span>
        <div class="admin-dropdown">
          <button class="admin-logout" id="logoutBtn" type="button" aria-label="Log out">Logout</button>
        </div>
      </div>
      <a class="bell" href="adminNotification.html" title="Notifications">üîî</a>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <ul>
        <li><a href="adminSlumAnalytics.html">üìä Slum Analytics</a></li>
        <li><a href="adminNgoAnalytics.html">üìà NGO Analytics</a></li>
        <li class="active"><a href="adminslumdivision.html">üè† Slum Residents</a></li>
        <li><a href="adminFieldAgents.html">üßë‚Äçüíº Field Agents</a></li>
        <li><a href="adminactivengo.html">‚úÖ Active NGOs</a></li>
        <li><a href="adminlocalauthority.html">üèõ Local Authority</a></li>
        <li><a href="adminVerifyNgo.html">‚úî Verify NGOs</a></li>
      </ul>
    </aside>

    <main class="content">
      <div class="page-header">
        
      </div>

      <div class="table-card">
        <div class="card-header">
          <h2>Pending Accounts</h2>
        </div>
        <table class="pending-table">
          <thead>
            <tr>
              <th>Full Name</th>
              <th>Slum Code</th>
              <th>NID</th>
              <th>Mobile</th>
              <th>Area</th>
              <th>District</th>
              <th>Division</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="pendingTableBody">
            <tr><td colspan="9" style="text-align: center; color: #999;">Loading...</td></tr>
          </tbody>
        </table>
        <div class="footer">
          <span>Showing data</span>
          <div class="pagination" id="pagination"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Approve Confirmation Modal -->
  <div class="modal-overlay" id="approveModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">Approve Account</div>
      <div class="modal-body" id="approveModalBody">Are you sure you want to approve this account?</div>
      <div class="modal-actions">
        <button id="cancelApprove" type="button" class="btn-approve-secondary">Cancel</button>
        <button id="confirmApprove" type="button" class="btn-approve-primary">Approve</button>
      </div>
    </div>
  </div>

  <!-- Reject Confirmation Modal -->
  <div class="modal-overlay" id="rejectModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">Reject Account</div>
      <div class="modal-body" id="rejectModalBody">Are you sure you want to reject and delete this account?</div>
      <div class="modal-actions">
        <button id="cancelReject" type="button" class="btn-approve-secondary">Cancel</button>
        <button id="confirmReject" type="button" class="btn-approve-primary">Reject</button>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="modal-overlay" id="successModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">Success</div>
      <div class="modal-body" id="successModalBody"></div>
      <div class="modal-actions">
        <button id="closeSuccess" type="button" style="background-color: #2d7a3d; color: white;">Close</button>
      </div>
    </div>
  </div>

  <!-- Logout Modal -->
  <div class="modal-overlay" id="logoutModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="logoutTitle">
      <div class="modal-header" id="logoutTitle">Log out</div>
      <div class="modal-body">You're currently signed in as Admin. Do you want to log out and return to the home page?</div>
      <div class="modal-actions">
        <button id="cancelLogout" type="button">Cancel</button>
        <button id="confirmLogout" type="button" style="background-color: #8b6f5a; color: white;">Log out</button>
      </div>
    </div>
  </div>

  <script src="adminSlumAnalytics.js"></script>
  <script>
    let pendingAccounts = [];
    let currentApproveId = -1;
    let currentRejectId = -1;

    document.addEventListener('DOMContentLoaded', async function () {
      const tableBody = document.getElementById('pendingTableBody');
      const params = new URLSearchParams(window.location.search);
      const slumParam = (params.get('slum') || '').trim();
      const districtParam = (params.get('district') || '').trim();
      const divisionParam = (params.get('division') || '').trim();

      function normalize(value) {
        return String(value || '').trim().toLowerCase();
      }

      // Fetch pending accounts from database
      async function fetchPendingAccounts() {
        try {
          const response = await fetch('/api/slum-dweller/pending');
          const result = await response.json();
          if (result.status === 'success') {
            pendingAccounts = result.data || [];
            renderRows();
          } else {
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: red;">Failed to load accounts: ' + result.message + '</td></tr>';
          }
        } catch (error) {
          console.error('Error fetching pending accounts:', error);
          tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: red;">Error loading accounts. Please try again.</td></tr>';
        }
      }

      function renderRows() {
        tableBody.innerHTML = '';

        const filtered = (pendingAccounts || []).filter((account) => {
          if (account.status && normalize(account.status) !== 'pending') return false;
          if (slumParam && normalize(account.area) !== normalize(slumParam)) return false;
          if (districtParam && normalize(account.district) !== normalize(districtParam)) return false;
          if (divisionParam && normalize(account.division) !== normalize(divisionParam)) return false;
          return true;
        });

        if (filtered.length === 0) {
          const emptyRow = document.createElement('tr');
          const emptyCell = document.createElement('td');
          emptyCell.colSpan = 9;
          emptyCell.style.textAlign = 'center';
          emptyCell.style.color = '#8b6f5a';
          emptyCell.textContent = 'No pending accounts.';
          emptyRow.appendChild(emptyCell);
          tableBody.appendChild(emptyRow);
          return;
        }

        filtered.forEach(function (account) {
          const row = document.createElement('tr');

          // Name
          const nameCell = document.createElement('td');
          nameCell.textContent = account.full_name || 'Unknown';
          row.appendChild(nameCell);

          // Slum Code
          const slumCell = document.createElement('td');
          slumCell.textContent = account.slum_code || '‚Äî';
          row.appendChild(slumCell);

          // NID
          const nidCell = document.createElement('td');
          nidCell.textContent = account.nid || '‚Äî';
          row.appendChild(nidCell);

          // Mobile
          const mobileCell = document.createElement('td');
          mobileCell.textContent = account.mobile || '‚Äî';
          row.appendChild(mobileCell);

          // Area
          const areaCell = document.createElement('td');
          areaCell.textContent = account.area || '‚Äî';
          row.appendChild(areaCell);

          // District
          const districtCell = document.createElement('td');
          districtCell.textContent = account.district || '‚Äî';
          row.appendChild(districtCell);

          // Division
          const divisionCell = document.createElement('td');
          divisionCell.textContent = account.division || '‚Äî';
          row.appendChild(divisionCell);

          // Status
          const statusCell = document.createElement('td');
          statusCell.textContent = 'Pending';
          statusCell.style.color = '#d9a574';
          statusCell.style.fontWeight = 'bold';
          row.appendChild(statusCell);

          // Actions
          const actionsCell = document.createElement('td');
          actionsCell.className = 'pending-actions';

          const viewBtn = document.createElement('button');
          viewBtn.textContent = 'View';
          viewBtn.className = 'btn-approve';
          viewBtn.style.background = 'rgba(139, 111, 90, 0.3)';
          viewBtn.style.color = '#8b6f5a';
          viewBtn.onclick = () => {
            sessionStorage.setItem('selectedSlumDweller', JSON.stringify(account));
            window.location.href = 'SlumResidentsInfo.html?id=' + account.id;
          };

          const approveBtn = document.createElement('button');
          approveBtn.textContent = 'Approve';
          approveBtn.className = 'btn-approve';
          approveBtn.onclick = () => {
            currentApproveId = account.id;
            openApproveModal(account.full_name || 'resident');
          };

          const rejectBtn = document.createElement('button');
          rejectBtn.textContent = 'Reject';
          rejectBtn.className = 'btn-reject';
          rejectBtn.onclick = () => {
            currentRejectId = account.id;
            openRejectModal(account.full_name || 'resident');
          };

          actionsCell.appendChild(viewBtn);
          actionsCell.appendChild(approveBtn);
          actionsCell.appendChild(rejectBtn);
          row.appendChild(actionsCell);

          tableBody.appendChild(row);
        });
      }

      // Modal functions
      function openApproveModal(name) {
        const modal = document.getElementById('approveModal');
        const body = document.getElementById('approveModalBody');
        body.textContent = 'Are you sure you want to approve ' + name + '\'s account? They will be moved to active accounts.';
        modal.setAttribute('aria-hidden', 'false');
        modal.classList.add('show');
      }

      function closeApproveModal() {
        const modal = document.getElementById('approveModal');
        modal.setAttribute('aria-hidden', 'true');
        modal.classList.remove('show');
        currentApproveId = -1;
      }

      function openRejectModal(name) {
        const modal = document.getElementById('rejectModal');
        const body = document.getElementById('rejectModalBody');
        body.textContent = 'Are you sure you want to reject and delete ' + name + '\'s account and all associated records?';
        modal.setAttribute('aria-hidden', 'false');
        modal.classList.add('show');
      }

      function closeRejectModal() {
        const modal = document.getElementById('rejectModal');
        modal.setAttribute('aria-hidden', 'true');
        modal.classList.remove('show');
        currentRejectId = -1;
      }

      function showSuccessModal(message) {
        const modal = document.getElementById('successModal');
        const body = document.getElementById('successModalBody');
        body.textContent = message;
        modal.setAttribute('aria-hidden', 'false');
        modal.classList.add('show');
      }

      function closeSuccessModal() {
        const modal = document.getElementById('successModal');
        modal.setAttribute('aria-hidden', 'true');
        modal.classList.remove('show');
      }

      // Approve button handler
      document.getElementById('confirmApprove').addEventListener('click', async function() {
        if (currentApproveId < 0) return;
        
        try {
          const response = await fetch(`/api/slum-dweller/${currentApproveId}/approve`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' }
          });
          const result = await response.json();
          
          if (result.status === 'success') {
            closeApproveModal();
            showSuccessModal('Account approved successfully! Account moved to Active Accounts.');
            setTimeout(() => {
              closeSuccessModal();
              fetchPendingAccounts(); // Refresh the list
            }, 2000);
          } else {
            alert('Failed to approve: ' + result.message);
          }
        } catch (error) {
          console.error('Error approving account:', error);
          alert('Error approving account. Please try again.');
        }
      });

      // Reject button handler
      document.getElementById('confirmReject').addEventListener('click', async function() {
        if (currentRejectId < 0) return;
        
        try {
          const response = await fetch(`/api/slum-dweller/${currentRejectId}`, {
            method: 'DELETE'
          });
          const result = await response.json();
          
          if (result.status === 'success') {
            closeRejectModal();
            showSuccessModal('Account rejected and deleted successfully.');
            setTimeout(() => {
              closeSuccessModal();
              fetchPendingAccounts(); // Refresh the list
            }, 2000);
          } else {
            alert('Failed to reject: ' + result.message);
          }
        } catch (error) {
          console.error('Error rejecting account:', error);
          alert('Error rejecting account. Please try again.');
        }
      });

      document.getElementById('cancelApprove').addEventListener('click', closeApproveModal);
      document.getElementById('approveModal').addEventListener('click', function(e) {
        if (e.target === this) closeApproveModal();
      });

      document.getElementById('cancelReject').addEventListener('click', closeRejectModal);
      document.getElementById('rejectModal').addEventListener('click', function(e) {
        if (e.target === this) closeRejectModal();
      });

      document.getElementById('closeSuccess').addEventListener('click', closeSuccessModal);
      document.getElementById('successModal').addEventListener('click', function(e) {
        if (e.target === this) closeSuccessModal();
      });

      // Initial fetch
      fetchPendingAccounts();
    });
  </script>
</body>
</html>
