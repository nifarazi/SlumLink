<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SLUMLINK ¬∑ NGO Information</title>
  <link rel="stylesheet" href="adminSlumAnalytics.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    .ngo-info-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid #d4c5b9;
    }

    .info-header h1 {
      color: #5a4a3a;
      margin: 0;
      font-size: 28px;
    }

    .back-button {
      padding: 10px 20px;
      background-color: #8b6f5a;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background-color 0.3s;
    }

    .back-button:hover {
      background-color: #6f5a47;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .info-field {
      background: #faf6f1;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #b39f94;
    }

    .info-field label {
      display: block;
      font-weight: 600;
      color: #5a4a3a;
      margin-bottom: 5px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-field p {
      margin: 0;
      color: #333;
      font-size: 15px;
      word-break: break-word;
    }

    .info-full-width {
      grid-column: 1 / -1;
    }

    .document-section {
      background: #faf6f1;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center;
    }

    .document-section h3 {
      color: #5a4a3a;
      margin-top: 0;
      margin-bottom: 15px;
    }

    .doc-preview {
      max-width: 500px;
      max-height: 400px;
      margin: 15px auto;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .doc-preview:hover {
      transform: scale(1.02);
    }

    .download-button {
      padding: 10px 20px;
      background-color: #8b6f5a;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
      transition: background-color 0.3s;
    }

    .download-button:hover {
      background-color: #6f5a47;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .image-modal {
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 90%;
      max-height: 90vh;
      overflow: auto;
      position: relative;
    }

    .close-image-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
    }

    .close-image-modal:hover {
      color: #000;
    }

    #modalImage {
      width: 100%;
      max-height: 80vh;
      object-fit: contain;
    }

    .image-caption {
      text-align: center;
      color: #666;
      margin-top: 10px;
      font-size: 14px;
    }

    .no-data {
      color: #8b6f5a;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="logo">SLUMLINK</div>
    <input type="text" placeholder="Search" class="search" />
    <div class="top-right">
      <div class="admin">
        <span>Admin ‚ñæ</span>
        <div class="admin-dropdown">
          <button class="admin-logout">Logout</button>
        </div>
      </div>
      <a class="bell" href="adminNotification.html" title="Notifications">üîî</a>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <ul>
        <li><a href="adminSlumAnalytics.html">üìä Slum Analytics</a></li>
        <li><a href="adminNgoAnalytics.html">üìà NGO Analytics</a></li>
        <li><a href="adminSlumResidents.html">üè† Slum Residents</a></li>
        <li><a href="adminFieldAgents.html">üßë‚Äçüíº Field Agents</a></li>
        <li><a href="adminVerifyNgo.html">‚úî Verify NGOs</a></li>
      </ul>
    </aside>

    <main class="content">
      <div class="ngo-info-container">
        <div class="info-header">
          <h1 id="ngoName">NGO Information</h1>
          <div style="display: flex; gap: 10px;">
            <button class="back-button" id="generateReportBtn">üìÑ Generate Report</button>
            <button class="back-button" onclick="goBack()">‚Üê Back to Verification</button>
          </div>
        </div>

        <div id="ngoContent">
          <!-- NGO info will be loaded here -->
        </div>
      </div>
    </main>
  </div>

  <!-- Image Modal -->
  <div class="modal-overlay" id="imageModal" aria-hidden="true">
    <div class="image-modal" role="dialog" aria-modal="true">
      <button class="close-image-modal" id="closeImageModal" aria-label="Close">&times;</button>
      <img id="modalImage" src="" alt="Document preview">
      <div class="image-caption" id="imageCaption"></div>
      <button class="download-button" id="downloadImageBtn" style="margin-top: 15px;">
        üì• Download Image
      </button>
    </div>
  </div>

  <!-- Logout Modal -->
  <div class="modal-overlay" id="logoutModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="logoutTitle">
      <div class="modal-header" id="logoutTitle">Log out</div>
      <div class="modal-body">You're currently signed in as Admin. Do you want to log out and return to the home page?</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelLogout">Cancel</button>
        <button class="btn btn-primary" id="confirmLogout">Log out</button>
      </div>
    </div>
  </div>

  <script src="adminSlumAnalytics.js"></script>
  <script>
    var currentNGO = null;

    function goBack() {
      window.location.href = 'adminVerifyNgo.html';
    }

    function openImageModal(src, caption) {
      var modal = document.getElementById('imageModal');
      var img = document.getElementById('modalImage');
      var captionEl = document.getElementById('imageCaption');
      img.src = src;
      captionEl.textContent = caption || '';
      modal.setAttribute('aria-hidden', 'false');
      modal.classList.add('show');
    }

    function closeImageModal() {
      var modal = document.getElementById('imageModal');
      modal.setAttribute('aria-hidden', 'true');
      modal.classList.remove('show');
    }

    function downloadImage(src, caption) {
      var fileName = caption.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.jpg';
      
      fetch(src)
        .then(function(response) { return response.blob(); })
        .then(function(blob) {
          var url = window.URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        })
        .catch(function() { alert('Failed to download image'); });
    }

    document.getElementById('closeImageModal').addEventListener('click', closeImageModal);
    
    document.getElementById('imageModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeImageModal();
      }
    });

    document.getElementById('downloadImageBtn').addEventListener('click', function() {
      var img = document.getElementById('modalImage');
      var caption = document.getElementById('imageCaption');
      downloadImage(img.src, caption.textContent);
    });

    // Load NGO data when page loads
    document.addEventListener('DOMContentLoaded', function() {
      var selectedNGO = sessionStorage.getItem('selectedNGO');
      
      if (!selectedNGO) {
        document.getElementById('ngoContent').innerHTML = '<div class="no-data">No NGO data available. Please select an NGO from the verification list.</div>';
        return;
      }

      var ngo = JSON.parse(selectedNGO);
      currentNGO = ngo;
      document.getElementById('ngoName').textContent = ngo.name;

      var content = '<div class="info-grid">';
      
      // Foundation Name
      content += '<div class="info-field">';
      content += '<label>Foundation Name</label>';
      content += '<p>' + (ngo.name || 'N/A') + '</p>';
      content += '</div>';

      // Email
      content += '<div class="info-field">';
      content += '<label>Email</label>';
      content += '<p>' + (ngo.email || 'N/A') + '</p>';
      content += '</div>';

      // Phone Number
      content += '<div class="info-field">';
      content += '<label>Phone Number</label>';
      content += '<p>' + (ngo.phone || 'N/A') + '</p>';
      content += '</div>';

      // Organization Year
      content += '<div class="info-field">';
      content += '<label>Organization Year</label>';
      content += '<p>' + (ngo.year || 'N/A') + '</p>';
      content += '</div>';

      // Location
      content += '<div class="info-field">';
      content += '<label>Location</label>';
      content += '<p>' + (ngo.location || 'N/A') + '</p>';
      content += '</div>';

      content += '</div>';

      // Document Section
      if (ngo.registrationDoc) {
        content += '<div class="document-section">';
        content += '<h3>Organization License</h3>';
        content += '<img src="' + ngo.registrationDoc + '" alt="Organization License" class="doc-preview" onclick="openImageModal(\'' + ngo.registrationDoc + '\', \'Organization License - ' + ngo.name + '\')">';
        content += '<div style="margin-top: 10px;">';
        content += '<button class="download-button" onclick="downloadImage(\'' + ngo.registrationDoc + '\', \'Organization License - ' + ngo.name + '\')">üì• Download Document</button>';
        content += '</div>';
        content += '</div>';
      }

      document.getElementById('ngoContent').innerHTML = content;
    });

    // PDF Generation
    document.getElementById('generateReportBtn').addEventListener('click', function() {
      if (!currentNGO) {
        alert('NGO data not found');
        return;
      }

      var jsPDFCtor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
      if (!jsPDFCtor) { alert('PDF library not loaded'); return; }
      
      var doc = new jsPDFCtor({ unit: 'mm', format: 'a4' });
      var pageWidth = doc.internal.pageSize.getWidth();
      var margin = 15;
      var y = margin;
      var lineHeight = 7;

      // Title
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(139, 111, 90);
      doc.text('SLUMLINK - NGO Information Report', pageWidth / 2, y, { align: 'center' });
      y += 15;

      // NGO Name Header
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(80, 80, 80);
      doc.text('NGO: ' + currentNGO.name, margin, y);
      y += 10;

      // Generated Date
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text('Generated on: ' + new Date().toLocaleString(), margin, y);
      y += 10;

      // Divider line
      doc.setDrawColor(139, 111, 90);
      doc.line(margin, y, pageWidth - margin, y);
      y += 8;

      // Organization Information Section
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(139, 111, 90);
      doc.text('Organization Information', margin, y);
      y += 8;

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(80, 80, 80);
      
      var orgData = [
        ['Foundation Name:', String(currentNGO.name)],
        ['Email:', String(currentNGO.email || 'N/A')],
        ['Phone Number:', String(currentNGO.phone || 'N/A')],
        ['Organization Year:', String(currentNGO.year || 'N/A')],
        ['Location:', String(currentNGO.location || 'N/A')]
      ];

      orgData.forEach(function(item) {
        if (y > 270) {
          doc.addPage();
          y = margin;
        }
        doc.text(item[0], margin + 5, y);
        doc.text(item[1], margin + 60, y);
        y += lineHeight;
      });

      y += 5;

      // Documents Section - Add organization license image
      if (currentNGO.registrationDoc) {
        doc.addPage();
        y = margin;
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(139, 111, 90);
        doc.text('Documents', margin, y);
        y += 12;
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(80, 80, 80);
        doc.text('Organization License:', margin, y);
        y += 8;
        
        try {
          doc.addImage(currentNGO.registrationDoc, 'JPEG', margin + 5, y, 80, 80);
          y += 85;
        } catch(e) {
          doc.text('[Document image not available]', margin + 5, y);
          y += 8;
        }
      }

      // Footer
      var pageCount = doc.getNumberOfPages();
      for (var i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text('Page ' + i + ' of ' + pageCount, pageWidth / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
      }

      // Save PDF
      doc.save(currentNGO.name.replace(/[^a-z0-9]+/gi, '_').toLowerCase() + '_information_report.pdf');
    });
  </script>
</body>
</html>
